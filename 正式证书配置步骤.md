# 正式证书配置步骤

> **包名**: `com.mtx.take.code`  
> **密码**: `miao1234`  
> **创建时间**: 2025-10-24

---

## 📋 需要准备的文件

从华为开发者平台申请证书后，你应该有以下文件：

| 文件类型 | 文件名示例 | 说明 | 必需 |
|---------|-----------|------|------|
| **密钥文件** | `pickcode.p12` | 私钥（可能已有） | ✅ 必需 |
| **证书文件** | `pickcode.cer` 或 `xxx.cer` | 从AppGallery下载 | ✅ 必需 |
| **Profile文件** | `pickcode.p7b` 或 `xxx.p7b` | 从AppGallery下载 | ✅ 必需 |

---

## 🔍 第一步：定位你的证书文件

### 方法 1: 检查下载文件夹

证书文件通常下载到：

```
C:\Users\你的用户名\Downloads\
```

查找文件：
- `xxx.cer` (证书文件)
- `xxx.p7b` (Profile配置文件)

---

### 方法 2: 从 AppGallery Connect 重新下载

如果找不到文件，可以重新下载：

1. 登录 [AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html)
2. 选择你的应用
3. 在左侧菜单找到 **证书管理**
4. 下载证书（.cer）
5. 下载 Profile 文件（.p7b）

---

## 📂 第二步：整理证书文件

### 创建签名目录结构

```
F:\HarmonyOS\PickCode\signature\
├── pickcode.p12      ← 密钥文件（如果没有需要生成）
├── pickcode.cer      ← 证书文件（从AppGallery下载）
└── pickcode.p7b      ← Profile文件（从AppGallery下载）
```

---

### 复制证书文件到项目

**如果证书文件在下载文件夹**：

```powershell
# 复制证书文件到项目（请根据实际文件名修改）
Copy-Item "$env:USERPROFILE\Downloads\你的证书.cer" -Destination "signature\pickcode.cer"
Copy-Item "$env:USERPROFILE\Downloads\你的Profile.p7b" -Destination "signature\pickcode.p7b"
```

**或者手动复制**：
1. 打开 `F:\HarmonyOS\PickCode\signature\` 目录
2. 将下载的 `.cer` 和 `.p7b` 文件复制到这里
3. 重命名为 `pickcode.cer` 和 `pickcode.p7b`（建议）

---

## 🔑 第三步：准备密钥文件 (.p12)

### 情况 A: 如果你已经有 .p12 文件

如果申请证书时生成了 .p12 文件：

```powershell
# 复制到项目
Copy-Item "你的p12文件路径\xxx.p12" -Destination "signature\pickcode.p12"
```

---

### 情况 B: 如果没有 .p12 文件，需要生成

**使用 DevEco Studio 生成（推荐）**：

1. 打开 DevEco Studio
2. 点击菜单 **Build** → **Generate Key and CSR**
3. 填写信息：
   ```
   Key Alias:          pickcode_key
   Password:           miao1234
   Confirm Password:   miao1234
   Validity (Years):   25
   
   Certificate:
   First and Last Name:     MTX PickCode
   Organization Unit:       Development
   Organization:            MTX
   City or Locality:        Beijing
   State or Province:       Beijing
   Country Code:            CN
   ```
4. 选择保存位置：
   ```
   F:\HarmonyOS\PickCode\signature\pickcode.p12
   ```
5. 点击 **OK** 生成

---

## ⚙️ 第四步：配置 build-profile.json5

编辑项目根目录的 `build-profile.json5`：

```json5
{
  "app": {
    "signingConfigs": [
      {
        "name": "default",
        "type": "HarmonyOS",
        "material": {
          "storeFile": "signature/pickcode.p12",
          "storePassword": "miao1234",
          "keyAlias": "pickcode_key",
          "keyPassword": "miao1234",
          "signAlg": "SHA256withRSA",
          "certpath": "signature/pickcode.cer",
          "profile": "signature/pickcode.p7b"
        }
      },
      {
        "name": "release",
        "type": "HarmonyOS",
        "material": {
          "storeFile": "signature/pickcode.p12",
          "storePassword": "miao1234",
          "keyAlias": "pickcode_key",
          "keyPassword": "miao1234",
          "signAlg": "SHA256withRSA",
          "certpath": "signature/pickcode.cer",
          "profile": "signature/pickcode.p7b"
        }
      }
    ],
    "products": [
      {
        "name": "default",
        "signingConfig": "default",
        "targetSdkVersion": "6.0.0(20)",
        "compatibleSdkVersion": "6.0.0(20)",
        "runtimeOS": "HarmonyOS",
        "buildOption": {
          "strictMode": {
            "caseSensitiveCheck": true,
            "useNormalizedOHMUrl": true
          }
        }
      }
    ],
    "buildModeSet": [
      {
        "name": "debug",
      },
      {
        "name": "release"
      }
    ]
  },
  "modules": [
    {
      "name": "entry",
      "srcPath": "./entry",
      "targets": [
        {
          "name": "default",
          "applyToProducts": [
            "default"
          ]
        }
      ]
    }
  ]
}
```

---

## ✅ 第五步：验证配置

### 1. 检查文件是否齐全

```powershell
# 在项目根目录运行
Get-ChildItem signature\

# 应该看到：
# pickcode.p12  ✅
# pickcode.cer  ✅
# pickcode.p7b  ✅
```

---

### 2. 验证文件权限

```powershell
# 确保文件可读
Test-Path signature\pickcode.p12
Test-Path signature\pickcode.cer
Test-Path signature\pickcode.p7b

# 都应该返回 True
```

---

## 🔨 第六步：重新构建

### 在 DevEco Studio 中：

```
1. File → Invalidate Caches / Restart（清除缓存）
2. Build → Clean Project
3. Build → Rebuild Project
4. Build → Build Hap(s)
```

---

### 构建发布版本：

```
1. 确保签名配置正确
2. Build → Generate Hap(s)/App(s) → Generate Signed Hap(s)
3. 选择 "release" 签名配置
4. 点击 OK 开始打包
```

**输出位置**：
```
entry/build/default/outputs/default/entry-default-signed.hap
```

---

## 🧪 第七步：测试签名

### 安装到设备测试

```powershell
# 卸载旧版本
hdc uninstall com.mtx.take.code

# 安装新签名的版本
hdc install entry\build\default\outputs\default\entry-default-signed.hap

# 启动应用
hdc shell aa start -a EntryAbility -b com.mtx.take.code
```

---

### 验证签名信息

```powershell
# 查看应用信息
hdc shell bm dump -n com.mtx.take.code

# 查看签名信息（如果有工具）
# 检查是否是正式签名
```

---

## 🎯 快速配置脚本

创建 `configure_release_signing.ps1` 脚本：

```powershell
#!/usr/bin/env pwsh
# 正式证书配置脚本

Write-Host "=====================================" -ForegroundColor Cyan
Write-Host "  正式证书配置工具" -ForegroundColor Cyan
Write-Host "=====================================" -ForegroundColor Cyan
Write-Host ""

# 检查必需文件
$requiredFiles = @(
    "signature\pickcode.p12",
    "signature\pickcode.cer",
    "signature\pickcode.p7b"
)

$allFilesExist = $true
foreach ($file in $requiredFiles) {
    if (Test-Path $file) {
        Write-Host "✓ 找到: $file" -ForegroundColor Green
    } else {
        Write-Host "✗ 缺少: $file" -ForegroundColor Red
        $allFilesExist = $false
    }
}

Write-Host ""

if (-not $allFilesExist) {
    Write-Host "请确保以下文件存在：" -ForegroundColor Yellow
    Write-Host "  1. signature\pickcode.p12  (密钥文件)" -ForegroundColor White
    Write-Host "  2. signature\pickcode.cer  (证书文件)" -ForegroundColor White
    Write-Host "  3. signature\pickcode.p7b  (Profile文件)" -ForegroundColor White
    Write-Host ""
    Write-Host "从 AppGallery Connect 下载证书文件后，复制到 signature 目录" -ForegroundColor Cyan
    exit 1
}

Write-Host "=====================================" -ForegroundColor Green
Write-Host "  所有证书文件已就绪！" -ForegroundColor Green
Write-Host "=====================================" -ForegroundColor Green
Write-Host ""
Write-Host "下一步：" -ForegroundColor Yellow
Write-Host "1. 在 DevEco Studio 中：Build → Clean Project" -ForegroundColor White
Write-Host "2. Build → Rebuild Project" -ForegroundColor White
Write-Host "3. Build → Generate Signed Hap(s)" -ForegroundColor White
Write-Host ""
```

**使用方法**：

```powershell
.\configure_release_signing.ps1
```

---

## 📝 配置示例

### 完整的签名配置

**目录结构**：
```
F:\HarmonyOS\PickCode\
├── signature\
│   ├── pickcode.p12      ← 密钥（密码: miao1234）
│   ├── pickcode.cer      ← 从AppGallery下载
│   └── pickcode.p7b      ← 从AppGallery下载
├── build-profile.json5   ← 已配置签名信息
└── AppScope\
    └── app.json5         ← bundleName: com.mtx.take.code
```

**签名参数**：
```
Store File:      signature/pickcode.p12
Store Password:  miao1234
Key Alias:       pickcode_key
Key Password:    miao1234
Cert Path:       signature/pickcode.cer
Profile:         signature/pickcode.p7b
Sign Algorithm:  SHA256withRSA
```

---

## ⚠️ 重要提示

### 1. 证书文件保密

```gitignore
# .gitignore 已配置，以下文件不会提交到 Git：
signature/*.p12   ✅
signature/*.cer   ✅
signature/*.p7b   ✅
*.p12            ✅
material/        ✅
```

### 2. 密码安全

- ✅ 密码已知：`miao1234`
- ⚠️ 不要泄露给他人
- ⚠️ 不要在公开渠道分享
- ✅ 发布版本可考虑使用更强的密码

### 3. 证书有效期

- 检查证书是否在有效期内
- 证书过期需要重新申请
- Profile 文件通常有效期为 1 年

### 4. Bundle Name 匹配

确保 AppGallery Connect 中的应用包名与项目一致：
```
AppGallery: com.mtx.take.code
项目配置:   com.mtx.take.code  ✅ 匹配
```

---

## 🔍 故障排查

### 问题 1: "签名失败 - 证书不匹配"

**原因**：证书的包名与项目不一致

**解决方案**：
1. 检查 AppGallery Connect 中的应用包名
2. 检查 `AppScope/app.json5` 中的 `bundleName`
3. 确保完全一致

---

### 问题 2: "Profile 文件无效"

**原因**：Profile 文件过期或不匹配

**解决方案**：
1. 登录 AppGallery Connect
2. 重新下载最新的 Profile 文件
3. 替换 `signature/pickcode.p7b`

---

### 问题 3: "密钥库密码错误"

**原因**：密码不正确

**解决方案**：
1. 确认密码：`miao1234`
2. 检查 `build-profile.json5` 中的密码配置
3. 如果密码确实不对，需要重新生成密钥文件

---

### 问题 4: "找不到签名文件"

**原因**：文件路径不对

**解决方案**：
```powershell
# 检查文件是否存在
Test-Path signature\pickcode.p12
Test-Path signature\pickcode.cer
Test-Path signature\pickcode.p7b

# 检查路径是否正确（相对于项目根目录）
```

---

## ✅ 配置完成检查清单

- [ ] 已从 AppGallery Connect 下载证书文件 (.cer)
- [ ] 已从 AppGallery Connect 下载 Profile 文件 (.p7b)
- [ ] 已有或已生成密钥文件 (.p12)
- [ ] 所有文件已复制到 `signature/` 目录
- [ ] 文件名正确：pickcode.p12, pickcode.cer, pickcode.p7b
- [ ] 已配置 `build-profile.json5`
- [ ] 密码正确：miao1234
- [ ] 包名匹配：com.mtx.take.code
- [ ] 已清理并重新构建项目
- [ ] 能成功生成签名的 HAP 包
- [ ] 签名的 HAP 包能成功安装到设备

---

## 📞 需要帮助？

### 如果证书文件找不到：

请告诉我证书文件的位置，我可以帮你：
1. 复制文件到正确的位置
2. 配置 build-profile.json5
3. 验证配置是否正确

### 如果配置遇到问题：

提供以下信息：
- 错误提示信息
- 当前 signature 目录的文件列表
- build-profile.json5 的配置内容

---

**当前配置信息**：
- 包名：`com.mtx.take.code`
- 密码：`miao1234`
- 密钥别名：`pickcode_key`

---

**文档版本**: v1.0  
**创建时间**: 2025-10-24  
**状态**: ✅ 待配置

