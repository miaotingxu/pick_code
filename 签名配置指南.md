# HarmonyOS 应用签名配置指南

## 一、使用 DevEco Studio 自动签名（推荐）

### 1. 打开签名配置
1. 在 DevEco Studio 中，点击菜单 `File` → `Project Structure`
2. 或者点击 `Build` → `Generate Key and CSR`

### 2. 自动签名配置（最简单）
1. 在 Project Structure 中选择 `Signing Configs`
2. 勾选 `Automatically generate signature` （自动生成签名）
3. 选择 `Support HarmonyOS`
4. 点击 `Apply` 和 `OK`

这样 DevEco Studio 会自动生成调试签名文件。

### 3. 手动创建签名文件（正式发布用）

#### 步骤 1: 生成密钥对
1. 点击 `Build` → `Generate Key and CSR`
2. 填写信息：
   - **Key Alias**: pickcode_key（密钥别名）
   - **Password**: 设置密码（至少8位，建议包含大小写字母+数字）
   - **Validity**: 25（有效期，年）
   - **Certificate**:
     - Organization: 你的组织名
     - Organization Unit: 开发部门
     - Country Code: CN
3. 选择保存路径，建议保存到项目根目录的 `signature` 文件夹
4. 点击 `OK` 生成 `.p12` 文件

#### 步骤 2: 申请调试证书（调试用）
1. 在 DevEco Studio 顶部菜单，点击 `File` → `Project Structure`
2. 选择 `Project` → `Signing Configs`
3. 勾选 `Support HarmonyOS`
4. 配置签名信息：
   - **Store File**: 选择刚才生成的 .p12 文件
   - **Store Password**: 输入密码
   - **Key Alias**: pickcode_key
   - **Key Password**: 输入密码
5. 点击 `Apply` 和 `OK`

## 二、命令行生成签名文件

如果想要完全手动控制，可以使用命令行：

### 1. 生成 .p12 密钥文件

```bash
# 进入 DevEco Studio SDK 的 toolchains 目录
cd %LOCALAPPDATA%\Huawei\Sdk\openharmony\[版本号]\toolchains

# 生成密钥对
keytool -genkeypair -keystore F:\HarmonyOS\PickCode\signature\pickcode.p12 -storetype PKCS12 -keyalg RSA -keysize 2048 -validity 9125 -alias pickcode_key -storepass your_password -keypass your_password -dname "CN=PickCode,OU=Development,O=MyCompany,L=Beijing,ST=Beijing,C=CN"
```

参数说明：
- `-keystore`: 密钥库文件路径
- `-alias`: 密钥别名
- `-storepass`: 密钥库密码
- `-keypass`: 密钥密码
- `-validity`: 有效期（天数，9125天=25年）
- `-dname`: 证书主题信息

### 2. 查看生成的密钥信息

```bash
keytool -list -v -keystore F:\HarmonyOS\PickCode\signature\pickcode.p12 -storepass your_password
```

## 三、配置签名到项目

### 方式 1: 修改 build-profile.json5

在项目根目录的 `build-profile.json5` 中添加签名配置：

```json5
{
  "app": {
    "signingConfigs": [
      {
        "name": "default",
        "type": "HarmonyOS",
        "material": {
          "certpath": "signature/pickcode.cer",
          "storePassword": "your_password",
          "keyAlias": "pickcode_key",
          "keyPassword": "your_password",
          "profile": "signature/pickcode.p7b",
          "signAlg": "SHA256withRSA",
          "storeFile": "signature/pickcode.p12"
        }
      },
      {
        "name": "release",
        "type": "HarmonyOS",
        "material": {
          "certpath": "signature/pickcode_release.cer",
          "storePassword": "your_password",
          "keyAlias": "pickcode_key",
          "keyPassword": "your_password",
          "profile": "signature/pickcode_release.p7b",
          "signAlg": "SHA256withRSA",
          "storeFile": "signature/pickcode.p12"
        }
      }
    ],
    "products": [
      {
        "name": "default",
        "signingConfig": "default",  // 使用 default 签名配置
        // ... 其他配置
      }
    ]
  }
}
```

### 方式 2: 使用本地签名配置（推荐）

为了不提交密码到版本控制，可以创建 `local.properties` 文件：

```properties
# 签名配置（不要提交到 Git）
signing.storeFile=signature/pickcode.p12
signing.storePassword=your_password
signing.keyAlias=pickcode_key
signing.keyPassword=your_password
```

## 四、完整流程总结

### 调试签名（开发测试用）
```bash
# 1. 创建 signature 目录
mkdir signature

# 2. 使用 DevEco Studio 自动签名（最简单）
File → Project Structure → Signing Configs → Automatically generate signature

# 或者手动配置调试证书
```

### 正式签名（发布用）
1. 生成 .p12 密钥文件（只需一次）
2. 在华为开发者平台申请证书和Profile文件：
   - 登录 [AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html)
   - 创建应用
   - 申请证书（.cer）
   - 申请 Profile 文件（.p7b）
3. 将证书和Profile文件放到 `signature` 目录
4. 配置 build-profile.json5
5. 打包发布

## 五、快速开始（推荐方案）

**对于初学者，最简单的方式：**

1. 打开 DevEco Studio
2. `File` → `Project Structure` → `Signing Configs`
3. 勾选 `Automatically generate signature`
4. 点击 `OK`
5. 直接运行项目，自动签名完成！

这样就可以在真机或模拟器上调试了。

## 六、注意事项

1. **密码安全**：
   - 不要将密码和 .p12 文件提交到 Git
   - 将 `signature/` 目录添加到 `.gitignore`

2. **证书有效期**：
   - 调试证书：通常1年
   - 发布证书：建议设置25年

3. **应用上架**：
   - 发布到华为应用市场需要正式签名
   - 需要在 AppGallery Connect 创建应用并申请证书

4. **多环境签名**：
   - debug: 调试签名（自动生成）
   - release: 发布签名（手动申请）

## 七、常见问题

### Q1: 找不到 keytool 命令？
A: keytool 在 OpenHarmony SDK 的 toolchains 目录下，或者使用系统的 Java keytool。

### Q2: 签名后还是安装失败？
A: 检查：
- 证书是否过期
- Profile 文件是否匹配
- 设备是否允许调试

### Q3: 如何切换签名配置？
A: 修改 `build-profile.json5` 中 products 的 `signingConfig` 字段。

