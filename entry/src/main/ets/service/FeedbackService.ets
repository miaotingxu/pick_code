/**
 * ç”¨æˆ·åé¦ˆæœåŠ¡
 * é€šè¿‡é£ä¹¦ Webhook æ”¶é›†ç”¨æˆ·éœ€æ±‚å’Œåé¦ˆ
 */
import http from '@ohos.net.http';
import deviceInfo from '@ohos.deviceInfo';

export class FeedbackData {
  content: string = '';
  contact?: string;
  type?: string;
  deviceInfo?: DeviceInfo;
}

class DeviceInfo {
  model: string = '';
  osVersion: string = '';
  appVersion: string = '';
}

export class FeedbackService {
  private static instance: FeedbackService;
  
  // âš ï¸ é‡è¦ï¼šå°†è¿™é‡Œæ›¿æ¢ä¸ºä½ çš„é£ä¹¦ Webhook åœ°å€
  private static readonly WEBHOOK_URL = 'https://open.feishu.cn/open-apis/bot/v2/hook/21470c0d-7155-49cb-b0c3-1e5030fc4edb';
  
  static getInstance(): FeedbackService {
    if (!FeedbackService.instance) {
      FeedbackService.instance = new FeedbackService();
    }
    return FeedbackService.instance;
  }

  /**
   * å‘é€ç”¨æˆ·åé¦ˆåˆ°é£ä¹¦ç¾¤
   * @param feedbackData åé¦ˆæ•°æ®
   * @returns Promise<boolean> æ˜¯å¦å‘é€æˆåŠŸ
   */
  async sendFeedback(feedbackData: FeedbackData): Promise<boolean> {
    try {
      // è·å–è®¾å¤‡ä¿¡æ¯
      const deviceInfoData: DeviceInfo = {
        model: deviceInfo.marketName || deviceInfo.productModel || 'æœªçŸ¥è®¾å¤‡',
        osVersion: deviceInfo.osFullName || 'æœªçŸ¥ç‰ˆæœ¬',
        appVersion: '1.0.0' // å¯ä»¥ä»é…ç½®è¯»å–
      };

      // æ„å»ºé£ä¹¦æ¶ˆæ¯å¡ç‰‡ï¼ˆå·²ç»æ˜¯ JSON å­—ç¬¦ä¸²ï¼‰
      const messageJson = this.buildFeishuCard(feedbackData, deviceInfoData);

      // å‘é€ HTTP è¯·æ±‚
      const httpRequest = http.createHttp();
      const response = await httpRequest.request(
        FeedbackService.WEBHOOK_URL,
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json'
          },
          extraData: messageJson,
          expectDataType: http.HttpDataType.STRING,
          connectTimeout: 10000,
          readTimeout: 10000
        }
      );

      // æ¸…ç†è¯·æ±‚å¯¹è±¡
      httpRequest.destroy();

      // æ£€æŸ¥å“åº”
      if (response.responseCode === 200) {
        console.info('[FeedbackService] åé¦ˆå‘é€æˆåŠŸ');
        return true;
      } else {
        console.error('[FeedbackService] åé¦ˆå‘é€å¤±è´¥:', response.responseCode);
        return false;
      }
    } catch (error) {
      console.error('[FeedbackService] å‘é€åé¦ˆå¼‚å¸¸:', JSON.stringify(error));
      return false;
    }
  }

  /**
   * æ„å»ºé£ä¹¦æ¶ˆæ¯å¡ç‰‡
   */
  private buildFeishuCard(feedbackData: FeedbackData, deviceInfoData: DeviceInfo): string {
    // åé¦ˆç±»å‹çš„ä¸­æ–‡æ˜ å°„
    let feedbackType = 'ğŸ’¬ å…¶ä»–åé¦ˆ';
    if (feedbackData.type === 'bug') {
      feedbackType = 'ğŸ› Bugåé¦ˆ';
    } else if (feedbackData.type === 'feature') {
      feedbackType = 'ğŸ’¡ åŠŸèƒ½å»ºè®®';
    }
    
    // å½“å‰æ—¶é—´
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hour = String(now.getHours()).padStart(2, '0');
    const minute = String(now.getMinutes()).padStart(2, '0');
    const second = String(now.getSeconds()).padStart(2, '0');
    const timeStr = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
    
    // è½¬ä¹‰ JSON å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦
    const escapeJson = (str: string): string => {
      return str.replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        .replace(/\t/g, '\\t');
    };
    
    const content = escapeJson(feedbackData.content);
    const contact = escapeJson(feedbackData.contact || 'æœªæä¾›');
    const model = escapeJson(deviceInfoData.model);
    const osVersion = escapeJson(deviceInfoData.osVersion);
    const appVersion = escapeJson(deviceInfoData.appVersion);

    // ç›´æ¥æ„å»º JSON å­—ç¬¦ä¸²ï¼Œå®Œå…¨é¿å…æ•°ç»„å­—é¢é‡ç±»å‹æ¨æ–­
    const message = '{"msg_type":"interactive","card":{"header":{"title":{"tag":"plain_text","content":"ğŸ“¬ æ”¶åˆ°æ–°çš„ç”¨æˆ·åé¦ˆ"},"template":"blue"},"elements":[' +
      '{"tag":"div","text":{"tag":"lark_md","content":"**åé¦ˆç±»å‹ï¼š**\\n' + feedbackType + '"}},' +
      '{"tag":"hr"},' +
      '{"tag":"div","text":{"tag":"lark_md","content":"**åé¦ˆå†…å®¹ï¼š**\\n' + content + '"}},' +
      '{"tag":"hr"},' +
      '{"tag":"div","fields":[' +
        '{"is_short":true,"text":{"tag":"lark_md","content":"**è”ç³»æ–¹å¼ï¼š**\\n' + contact + '"}},' +
        '{"is_short":true,"text":{"tag":"lark_md","content":"**æäº¤æ—¶é—´ï¼š**\\n' + timeStr + '"}}' +
      ']},' +
      '{"tag":"hr"},' +
      '{"tag":"div","text":{"tag":"lark_md","content":"**è®¾å¤‡ä¿¡æ¯ï¼š**\\nè®¾å¤‡ï¼š' + model + '\\nç³»ç»Ÿï¼š' + osVersion + '\\nåº”ç”¨ç‰ˆæœ¬ï¼š' + appVersion + '"}},' +
      '{"tag":"note","elements":[{"tag":"plain_text","content":"æ¥è‡ª PickCode ç”¨æˆ·åé¦ˆç³»ç»Ÿ"}]}' +
    ']}}';
    
    return message;
  }

  /**
   * å¿«é€Ÿå‘é€æ–‡æœ¬åé¦ˆï¼ˆç®€åŒ–ç‰ˆï¼‰
   */
  async sendQuickFeedback(content: string): Promise<boolean> {
    return await this.sendFeedback({
      content: content,
      type: 'other'
    });
  }
}

