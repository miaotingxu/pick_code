import { ParcelModel } from '../model/ParcelModel';
import { ParcelDatabase } from '../database/ParcelDatabase';
import { Constants } from '../common/Constants';
import { ScanService } from '../service/ScanService';
import { IconUtils } from '../utils/IconUtils';
import { router } from '@kit.ArkUI';
import { pasteboard } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';

@Entry
@Component
struct Index {
  @State currentTab: number = 0; // 0-å¾…å–, 1-å·²å–
  @State parcelList: ParcelModel[] = [];
  @State selectedFilter: string = 'æŒ‰æ—¶é—´';
  @State isEditMode: boolean = false;
  @State selectedParcels: Set<number> = new Set();
  @State groupedData: Map<string, ParcelModel[]> = new Map();
  @State sortedFilterTags: string[] = ['æŒ‰æ—¶é—´']; // åŠ¨æ€æ’åºçš„ç­›é€‰æ ‡ç­¾
  private database: ParcelDatabase = ParcelDatabase.getInstance();
  private scanService: ScanService = ScanService.getInstance();

  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®åº“
    const context = getContext(this) as common.UIAbilityContext;
    await this.database.initDB(context);
    // åŠ è½½æµ‹è¯•æ•°æ®ï¼ˆé¦–æ¬¡è¿è¡Œæ—¶ï¼‰
    await this.loadTestData();
    // åŠ è½½æ•°æ®
    await this.loadParcels();
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°
  async onPageShow() {
    await this.loadParcels();
  }

  // åŠ è½½æµ‹è¯•æ•°æ®
  async loadTestData() {
    const existingData = await this.database.queryAllParcels();
    if (existingData.length === 0) {
      // æ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®
      const testParcels = [
        new ParcelModel('2-5-2418', 'æå…”é€Ÿé€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '17:45', 0),
        new ParcelModel('6-2-2175', 'ä¸­é€šå¿«é€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '17:37', 0),
        new ParcelModel('6-2-2173', 'åœ†é€šé€Ÿé€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '17:37', 0),
        new ParcelModel('2-5-2498', 'äº¬ä¸œå¿«é€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '17:37', 0),
      ];

      for (const parcel of testParcels) {
        await this.database.insertParcel(parcel);
      }
    }
  }

  // åŠ è½½åŒ…è£¹æ•°æ®
  async loadParcels() {
    const status = this.currentTab === 0 ? Constants.STATUS_PENDING : Constants.STATUS_PICKED;
    this.parcelList = await this.database.queryParcelsByStatus(status);
    // æ›´æ–°ç­›é€‰æ ‡ç­¾æ’åºï¼ˆä»…åœ¨å¾…å–é¡µé¢ï¼‰
    if (this.currentTab === 0) {
      this.updateFilterTagsOrder();
    }
    // æ›´æ–°åˆ†ç»„æ•°æ®
    this.groupedData = this.getGroupedParcels();
  }

  // åŠ¨æ€æ›´æ–°ç­›é€‰æ ‡ç­¾æ’åº
  updateFilterTagsOrder() {
    // ç»Ÿè®¡æ¯ä¸ªå¿«é€’å…¬å¸çš„å¾…å–ä»¶æ•°é‡
    const companyCount = new Map<string, number>();

    // éå†æ‰€æœ‰å¾…å–åŒ…è£¹ï¼Œç»Ÿè®¡å„å¿«é€’å…¬å¸æ•°é‡
    this.parcelList.forEach(parcel => {
      const company = parcel.courierCompany;

      // åŒ¹é…å¿«é€’å…¬å¸ä¸ç­›é€‰æ ‡ç­¾çš„å¯¹åº”å…³ç³»
      Constants.FILTER_TAGS.forEach(tag => {
        if (tag === 'æŒ‰æ—¶é—´') {
          return;
        }

        // åˆ¤æ–­åŒ…è£¹æ˜¯å¦å±äºè¯¥å¿«é€’å…¬å¸
        let isMatch = false;

        if (tag === 'å…¶ä»–') {
          // "å…¶ä»–"åŒ¹é…æ‰€æœ‰éä¸»æµå¿«é€’
          let isMainCourier = false;
          for (const mainCourier of Constants.MAIN_COURIERS) {
            if (company.includes(mainCourier)) {
              isMainCourier = true;
              break;
            }
          }
          isMatch = !isMainCourier;
        } else if (tag === 'é¡ºä¸°' && company.includes('é¡ºä¸°')) {
          isMatch = true;
        } else if (tag === 'ä¸­é€š' && company.includes('ä¸­é€š')) {
          isMatch = true;
        } else if (tag === 'ç”³é€š' && company.includes('ç”³é€š')) {
          isMatch = true;
        } else if (tag === 'éŸµè¾¾' && company.includes('éŸµè¾¾')) {
          isMatch = true;
        } else if (tag === 'æå…”' && company.includes('æå…”')) {
          isMatch = true;
        } else if (tag === 'é‚®æ”¿' && (company.includes('é‚®æ”¿') || company.includes('EMS'))) {
          isMatch = true;
        } else if (tag === 'åœ†é€š' && company.includes('åœ†é€š')) {
          isMatch = true;
        } else if (tag === 'äº¬ä¸œ' && company.includes('äº¬ä¸œ')) {
          isMatch = true;
        } else if (tag === 'ç™¾ä¸–' && company.includes('ç™¾ä¸–')) {
          isMatch = true;
        }

        if (isMatch) {
          companyCount.set(tag, (companyCount.get(tag) || 0) + 1);
        }
      });
    });

    // å¯¹å¿«é€’å…¬å¸æ ‡ç­¾æ’åºï¼ˆæŒ‰å¾…å–ä»¶æ•°é‡é™åºï¼‰
    // "å…¶ä»–"å§‹ç»ˆæ”¾åœ¨æœ€å
    const sortedCompanies = Constants.FILTER_TAGS
      .filter(tag => tag !== 'æŒ‰æ—¶é—´' && tag !== 'å…¶ä»–')
      .sort((a, b) => {
        const countA = companyCount.get(a) || 0;
        const countB = companyCount.get(b) || 0;

        // å¦‚æœæ•°é‡ä¸åŒï¼Œæ•°é‡å¤šçš„æ’å‰é¢
        if (countA !== countB) {
          return countB - countA;
        }

        // å¦‚æœæ•°é‡ç›¸åŒï¼Œä¿æŒåŸæœ‰é¡ºåº
        return Constants.FILTER_TAGS.indexOf(a) - Constants.FILTER_TAGS.indexOf(b);
      });

    // ç»„åˆç»“æœï¼š"æŒ‰æ—¶é—´"åœ¨ç¬¬ä¸€ä½ï¼Œ"å…¶ä»–"åœ¨æœ€å
    const otherCount = companyCount.get('å…¶ä»–') || 0;
    if (otherCount > 0) {
      this.sortedFilterTags = ['æŒ‰æ—¶é—´', ...sortedCompanies, 'å…¶ä»–'];
    } else {
      this.sortedFilterTags = ['æŒ‰æ—¶é—´', ...sortedCompanies];
    }
  }

  // åˆ‡æ¢æ ‡ç­¾é¡µ
  async onTabChange(index: number) {
    this.currentTab = index;
    this.isEditMode = false;
    this.selectedParcels.clear();
    await this.loadParcels();
  }

  // åˆ‡æ¢åŒ…è£¹çŠ¶æ€
  async toggleParcelStatus(parcel: ParcelModel) {
    if (parcel.id) {
      const newStatus = parcel.status === Constants.STATUS_PENDING ?
        Constants.STATUS_PICKED : Constants.STATUS_PENDING;
      await this.database.updateParcelStatus(parcel.id, newStatus);
      await this.loadParcels();
    }
  }

  // å¤åˆ¶å–ä»¶ç 
  async copyPickupCode(code: string) {
    try {
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, code);
      const systemPasteboard = pasteboard.getSystemPasteboard();
      await systemPasteboard.setData(pasteData);
      promptAction.showToast({ message: 'å–ä»¶ç å·²å¤åˆ¶', duration: 2000 });
    } catch (error) {
      console.error('Copy failed:', JSON.stringify(error));
    }
  }

  // åˆ é™¤é€‰ä¸­çš„åŒ…è£¹
  async deleteSelectedParcels() {
    const ids = Array.from(this.selectedParcels);
    if (ids.length > 0) {
      await this.database.batchDeleteParcels(ids);
      this.selectedParcels.clear();
      this.isEditMode = false;
      await this.loadParcels();
      promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ', duration: 2000 });
    }
  }

  // è·³è½¬åˆ°æ·»åŠ é¡µé¢
  async navigateToAddPage() {
    await router.pushUrl({ url: 'pages/AddParcel' });
    // æ•°æ®åˆ·æ–°ç”± onPageShow() ç”Ÿå‘½å‘¨æœŸå¤„ç†
  }

  // è·å–å¿«é€’å…¬å¸å›¾æ ‡é¢œè‰²
  getCourierColor(company: string): string {
    return IconUtils.getCourierColor(company);
  }

  // è·å–å¿«é€’å…¬å¸ç¼©å†™
  getCourierAbbr(company: string): string {
    return IconUtils.getCourierAbbr(company);
  }

  // åº”ç”¨ç­›é€‰
  getFilteredParcels(): ParcelModel[] {
    if (this.selectedFilter === 'æŒ‰æ—¶é—´') {
      return this.parcelList;
    }

    // æŒ‰å¿«é€’å…¬å¸ç­›é€‰
    return this.parcelList.filter(parcel => {
      const company = parcel.courierCompany;

      // "å…¶ä»–"ç­›é€‰ï¼šåŒ…å«æ‰€æœ‰éä¸»æµå¿«é€’å…¬å¸
      if (this.selectedFilter === 'å…¶ä»–') {
        // æ£€æŸ¥æ˜¯å¦å±äºä¸»æµå¿«é€’
        let isMainCourier = false;
        for (const mainCourier of Constants.MAIN_COURIERS) {
          if (company.includes(mainCourier)) {
            isMainCourier = true;
            break;
          }
        }
        // è¿”å›éä¸»æµå¿«é€’ï¼ˆå¾·é‚¦ã€å¤©å¤©ã€å®…æ€¥é€ã€èœé¸Ÿã€å¦ˆå¦ˆã€å…”å–œç­‰ï¼‰
        return !isMainCourier;
      }

      // æ ¹æ®ç­›é€‰æ ‡ç­¾åŒ¹é…å¿«é€’å…¬å¸
      if (this.selectedFilter === 'é¡ºä¸°') {
        return company.includes('é¡ºä¸°');
      } else if (this.selectedFilter === 'ä¸­é€š') {
        return company.includes('ä¸­é€š');
      } else if (this.selectedFilter === 'ç”³é€š') {
        return company.includes('ç”³é€š');
      } else if (this.selectedFilter === 'éŸµè¾¾') {
        return company.includes('éŸµè¾¾');
      } else if (this.selectedFilter === 'æå…”') {
        return company.includes('æå…”');
      } else if (this.selectedFilter === 'é‚®æ”¿') {
        return company.includes('é‚®æ”¿') || company.includes('EMS');
      } else if (this.selectedFilter === 'åœ†é€š') {
        return company.includes('åœ†é€š');
      } else if (this.selectedFilter === 'äº¬ä¸œ') {
        return company.includes('äº¬ä¸œ');
      } else if (this.selectedFilter === 'ç™¾ä¸–') {
        return company.includes('ç™¾ä¸–');
      }

      return true;
    });
  }

  // æŒ‰æ—¥æœŸåˆ†ç»„
  getGroupedParcels(): Map<string, ParcelModel[]> {
    const grouped = new Map<string, ParcelModel[]>();
    let filteredList = this.getFilteredParcels();

    // å¦‚æœæ˜¯"æŒ‰æ—¶é—´"ç­›é€‰ï¼Œåˆ™æŒ‰å¿«é€’å…¬å¸æ•°é‡æ’åº
    if (this.selectedFilter === 'æŒ‰æ—¶é—´') {
      filteredList = this.sortParcelsByCompanyCount(filteredList);
    }

    filteredList.forEach(parcel => {
      const date = new Date(parcel.createTime);
      const dateKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

      if (!grouped.has(dateKey)) {
        grouped.set(dateKey, []);
      }
      grouped.get(dateKey)?.push(parcel);
    });

    return grouped;
  }

  // æŒ‰å¿«é€’å…¬å¸å¾…å–ä»¶æ•°é‡æ’åºåŒ…è£¹åˆ—è¡¨
  sortParcelsByCompanyCount(parcels: ParcelModel[]): ParcelModel[] {
    // 1. ç»Ÿè®¡æ¯ä¸ªå¿«é€’å…¬å¸çš„åŒ…è£¹æ•°é‡
    const companyCount = new Map<string, number>();
    parcels.forEach(parcel => {
      const company = parcel.courierCompany;
      companyCount.set(company, (companyCount.get(company) || 0) + 1);
    });

    // 2. æŒ‰å¿«é€’å…¬å¸åˆ†ç»„
    const companyGroups = new Map<string, ParcelModel[]>();
    parcels.forEach(parcel => {
      const company = parcel.courierCompany;
      if (!companyGroups.has(company)) {
        companyGroups.set(company, []);
      }
      companyGroups.get(company)?.push(parcel);
    });

    // 3. å¯¹æ¯ä¸ªå¿«é€’å…¬å¸çš„åŒ…è£¹æŒ‰æ—¶é—´æ’åº
    companyGroups.forEach((parcels, company) => {
      parcels.sort((a, b) => b.createTime - a.createTime);
    });

    // 4. æŒ‰å¿«é€’å…¬å¸çš„åŒ…è£¹æ•°é‡æ’åº
    const sortedCompanies = Array.from(companyGroups.keys()).sort((a, b) => {
      const countA = companyCount.get(a) || 0;
      const countB = companyCount.get(b) || 0;

      // æ•°é‡å¤šçš„æ’å‰é¢
      if (countA !== countB) {
        return countB - countA;
      }

      // æ•°é‡ç›¸åŒï¼ŒæŒ‰é¦–ä¸ªåŒ…è£¹çš„åˆ›å»ºæ—¶é—´æ’åº
      const parcelsA = companyGroups.get(a) || [];
      const parcelsB = companyGroups.get(b) || [];
      if (parcelsA.length > 0 && parcelsB.length > 0) {
        return parcelsB[0].createTime - parcelsA[0].createTime;
      }

      return 0;
    });

    // 5. ç»„åˆæ’åºåçš„ç»“æœ
    const sortedParcels: ParcelModel[] = [];
    sortedCompanies.forEach(company => {
      const companyParcels = companyGroups.get(company) || [];
      sortedParcels.push(...companyParcels);
    });

    return sortedParcels;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.TopBar()

      // ç­›é€‰åŒºåŸŸ
      if (this.currentTab === 0) {
        this.FilterBar()
      }

      // åˆ—è¡¨åŒºåŸŸ
      this.ParcelList()

      // åº•éƒ¨ TabBar
      this.BottomTabBar()
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_color'))
  }

  @Builder
  TopBar() {
    Row() {
      // å·¦ä¾§èœå•æŒ‰é’®
      Image($r('app.media.startIcon'))
        .width(24)
        .height(24)
        .margin({ left: 16 })

      // æ ‡é¢˜
      Text(this.currentTab === 0 ?
        `å¾…å–åŒ…è£¹ (${this.parcelList.length})` :
        'å–ä»¶è®°å½•')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .margin({ left: 16 })
        .layoutWeight(1)

      // å³ä¾§åŠŸèƒ½æŒ‰é’®
      Row({ space: 16 }) {
        // æ·»åŠ æŒ‰é’®
        Text('+')
          .fontSize(28)
          .fontWeight(FontWeight.Medium)
          .onClick(() => {
            this.navigateToAddPage();
          })

        // æ‰«ç æŒ‰é’®
        Text('âŠ')
          .fontSize(24)
          .fontWeight(FontWeight.Medium)
          .onClick(async () => {
            const context = getContext(this) as common.UIAbilityContext;
            await this.scanService.startScan(context);
            // æ‰«ç ååˆ·æ–°æ•°æ®
            await this.loadParcels();
          })

        // åˆ é™¤æŒ‰é’®ï¼ˆå·²å–é¡µé¢æ˜¾ç¤ºï¼‰
        if (this.currentTab === 1) {
          Image($r('app.media.startIcon'))
            .width(24)
            .height(24)
            .onClick(() => {
              this.isEditMode = !this.isEditMode;
              if (!this.isEditMode) {
                this.selectedParcels.clear();
              }
            })
        }
      }
      .margin({ right: 16 })
    }
    .width('100%')
    .height(56)
    .backgroundColor(Color.White)
    .padding({ top: 10, bottom: 10 })
  }

  @Builder
  FilterBar() {
    Row() {
      // ç­›é€‰æŒ‰é’®ï¼ˆå·¦ä¾§ï¼‰- ä½¿ç”¨ Scroll æ”¯æŒæ¨ªå‘æ»šåŠ¨ï¼ŒæŒ‰å¾…å–ä»¶æ•°é‡åŠ¨æ€æ’åº
      Scroll() {
        Row({ space: 8 }) {
          ForEach(this.sortedFilterTags, (tag: string) => {
            Text(tag)
              .fontSize(14)
              .fontColor(this.selectedFilter === tag ?
                $r('app.color.filter_button_active_text') :
                $r('app.color.filter_button_text'))
              .backgroundColor(this.selectedFilter === tag ?
                $r('app.color.filter_button_active_bg') :
                Color.Transparent)
              .border({
                width: this.selectedFilter === tag ? 0 : 1.5,
                color: this.selectedFilter === tag ? 
                  Color.Transparent : 
                  $r('app.color.tab_border_color')
              })
              .borderRadius(8)
              .padding({
                left: 16,
                right: 16,
                top: 8,
                bottom: 8
        })
        .onClick(() => {
                this.selectedFilter = tag;
                // æ›´æ–°åˆ†ç»„æ•°æ®ä»¥åº”ç”¨ç­›é€‰
                this.groupedData = this.getGroupedParcels();
              })
          })
        }
        .padding({ right: 8 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .layoutWeight(1)

      // å‹¾é€‰æ¡†ï¼ˆå³ä¾§ï¼‰
      Checkbox()
        .width(24)
        .height(24)
        .margin({ right: 16 })
    }
    .width('100%')
    .padding({ left: 16, top: 12, bottom: 12 })
    .backgroundColor(Color.White)
  }

  @Builder
  ParcelList() {
    if (this.parcelList.length === 0 || this.getFilteredParcels().length === 0) {
      // ç©ºçŠ¶æ€æç¤º
      this.EmptyState()
    } else {
      List({ space: 0 }) {
        ForEach(Array.from(this.groupedData.keys()), (date: string) => {
          ListItemGroup({ header: this.DateHeader(date, this.groupedData.get(date)?.length || 0) }) {
            ForEach(this.groupedData.get(date) || [], (parcel: ParcelModel) => {
              ListItem() {
                this.ParcelCard(parcel)
              }
            }, (parcel: ParcelModel) => parcel.id?.toString() || '')
          }
        })
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor($r('app.color.background_color'))
      .padding({ left: 16, right: 16 })
    }
  }

  @Builder
  EmptyState() {
    Column({ space: 16 }) {
      // ç©ºçŠ¶æ€å›¾æ ‡
      Text('ğŸ“¦')
        .fontSize(80)
        .margin({ top: 100 })

      // æç¤ºæ–‡å­—
      Text(this.getEmptyStateText())
        .fontSize(16)
        .fontColor($r('app.color.secondary_text'))
        .textAlign(TextAlign.Center)

      // æ“ä½œå»ºè®®
      if (this.selectedFilter !== 'æŒ‰æ—¶é—´') {
        Text('ç‚¹å‡»"æŒ‰æ—¶é—´"æŸ¥çœ‹æ‰€æœ‰åŒ…è£¹')
          .fontSize(14)
          .fontColor($r('app.color.accent_blue'))
          .margin({ top: 8 })
          .onClick(() => {
            this.selectedFilter = 'æŒ‰æ—¶é—´';
            this.groupedData = this.getGroupedParcels();
          })
      } else if (this.currentTab === 0) {
        // å¾…å–é¡µé¢ä¸”æ— æ•°æ®ï¼Œæç¤ºæ·»åŠ 
        Column({ space: 12 }) {
          Text('ç‚¹å‡»å³ä¸Šè§’ + å·æ·»åŠ å–ä»¶ç ')
            .fontSize(14)
            .fontColor($r('app.color.accent_blue'))

          Text('æˆ–ç‚¹å‡»æ‰«ç å›¾æ ‡æ‰«æå¿«é€’å•')
            .fontSize(14)
            .fontColor($r('app.color.secondary_text'))
        }
        .margin({ top: 12 })
      }
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .backgroundColor($r('app.color.background_color'))
  }

  // è·å–ç©ºçŠ¶æ€æç¤ºæ–‡å­—
  getEmptyStateText(): string {
    if (this.selectedFilter === 'æŒ‰æ—¶é—´') {
      return this.currentTab === 0 ?
        'æš‚æ— å¾…å–çš„å¿«é€’åŒ…è£¹' :
        'æš‚æ— å·²å–çš„å¿«é€’è®°å½•';
    } else if (this.selectedFilter === 'å…¶ä»–') {
      return 'æš‚æ— å…¶ä»–å¿«é€’å…¬å¸çš„åŒ…è£¹';
    } else {
      return `æš‚æ— ${this.selectedFilter}å¿«é€’çš„åŒ…è£¹`;
    }
  }

  @Builder
  DateHeader(date: string, count: number) {
    Row() {
      Text(date)
        .fontSize(14)
        .fontColor($r('app.color.secondary_text'))

      Blank()

      Text(`${count}æ¡è®°å½•`)
        .fontSize(14)
        .fontColor($r('app.color.secondary_text'))
    }
    .width('100%')
    .padding({ top: 12, bottom: 8 })
  }

  @Builder
  ParcelCard(parcel: ParcelModel) {
    Row() {
      // å·¦ä¾§ï¼šå¿«é€’å…¬å¸å›¾æ ‡ï¼ˆæ­£æ–¹å½¢å¸¦åœ†è§’ï¼‰
      this.CourierIconView(parcel.courierCompany, parcel.status)

      // ä¸­é—´ï¼šä¿¡æ¯åŒºåŸŸ
      Column({ space: 4 }) {
        // å¿«é€’å…¬å¸åç§°ï¼ˆæ ‡é¢˜ï¼‰
        Text(parcel.courierCompany)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(parcel.status === Constants.STATUS_PICKED ?
            $r('app.color.secondary_text') :
            $r('app.color.primary_text'))

        // é©¿ç«™åç§°å’Œåœ°å€
        Text(`${parcel.stationName} Â· ${parcel.address}`)
          .fontSize(13)
          .fontColor($r('app.color.secondary_text'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .opacity(parcel.status === Constants.STATUS_PICKED ? 0.6 : 1)

        // å–ä»¶ç ï¼ˆå¤§å·å­—ä½“ï¼‰
        Text(parcel.pickupCode)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor(parcel.status === Constants.STATUS_PICKED ?
            $r('app.color.secondary_text') :
            $r('app.color.primary_text'))
          .decoration({
            type: parcel.status === Constants.STATUS_PICKED ?
              TextDecorationType.LineThrough :
              TextDecorationType.None
          })
          .letterSpacing(2)
          .margin({ top: 4 })
          .gesture(
            LongPressGesture()
              .onAction(() => {
                this.copyPickupCode(parcel.pickupCode);
              })
          )
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // å³ä¾§ï¼šæ—¶é—´å’ŒçŠ¶æ€
      Column({ space: 8 }) {
        Text(`${parcel.pickupTime} ${this.currentTab === 0 ? '' : 'å–ä»¶'}`)
          .fontSize(13)
          .fontColor($r('app.color.primary_text'))
          .opacity(parcel.status === Constants.STATUS_PICKED ? 0.6 : 0.85)

        // å‹¾é€‰æ¡†
        if (this.currentTab === 0) {
          // å¾…å–ï¼šåœ†å½¢æ¡†
          Circle({ width: 24, height: 24 })
            .fill(Color.Transparent)
            .stroke($r('app.color.divider_color'))
            .strokeWidth(2)
            .onClick(() => {
              this.toggleParcelStatus(parcel);
            })
        } else {
          // å·²å–ï¼šè“è‰²å‹¾é€‰
          Stack() {
            Circle({ width: 24, height: 24 })
              .fill($r('app.color.accent_blue'))
            Text('âœ“')
              .fontSize(16)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
          .onClick(() => {
            this.toggleParcelStatus(parcel);
          })
        }
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .padding(16)
    .margin({ top: 6, bottom: 6 })
    .shadow({ 
      radius: 8, 
      color: '#15000000', 
      offsetX: 0, 
      offsetY: 2 
    })
    .border({
      width: 1,
      color: parcel.status === Constants.STATUS_PICKED ? 
        $r('app.color.divider_color') : 
        Color.Transparent
    })
  }

  // å¿«é€’å…¬å¸å›¾æ ‡ç»„ä»¶ï¼ˆæ™ºèƒ½æ˜¾ç¤ºçœŸå®å›¾æ ‡æˆ–æ–‡å­—å›¾æ ‡ï¼‰
  @Builder
  CourierIconView(company: string, status: number) {
    Stack() {
      // åº•å±‚ï¼šå½©è‰²èƒŒæ™¯ + æ–‡å­—å›¾æ ‡ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
      Stack() {
        Text(this.getCourierAbbr(company))
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .textShadow({ radius: 2, color: '#40000000', offsetX: 0, offsetY: 1 })
      }
      .width(48)
      .height(48)
      .backgroundColor(this.getCourierColor(company))
      .borderRadius(8)
      
      // é¡¶å±‚ï¼šçœŸå®å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      Image(this.getCourierIconResource(company))
        .width(48)
        .height(48)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
    }
    .width(48)
    .height(48)
    .opacity(status === Constants.STATUS_PICKED ? 0.5 : 1)
    .margin({ right: 12 })
  }

  // è·å–å¿«é€’å…¬å¸å›¾æ ‡èµ„æº
  getCourierIconResource(company: string): Resource {
    const lowerCompany = company.toLowerCase();

    // åŒ¹é… AppScope/resources/base/media ç›®å½•ä¸‹çš„çœŸå®å›¾æ ‡
    if (lowerCompany.includes('é¡ºä¸°') || lowerCompany.includes('sf')) {
      return $r('app.media.shunfeng'); // shunfeng.png
    } else if (lowerCompany.includes('ä¸­é€š') || lowerCompany.includes('zto')) {
      return $r('app.media.zhongtong'); // zhongtong.png
    } else if (lowerCompany.includes('ç”³é€š') || lowerCompany.includes('sto')) {
      return $r('app.media.shentong'); // shentong.png
    } else if (lowerCompany.includes('éŸµè¾¾')) {
      return $r('app.media.yunda'); // yunda.png
    } else if (lowerCompany.includes('æå…”') || lowerCompany.includes('jt') || lowerCompany.includes('j&t')) {
      return $r('app.media.jtexpress'); // jtexpress.png
    } else if (lowerCompany.includes('é‚®æ”¿') || lowerCompany.includes('ems')) {
      return $r('app.media.youzhengguonei'); // youzhengguonei.png
    } else if (lowerCompany.includes('åœ†é€š') || lowerCompany.includes('yto')) {
      return $r('app.media.yuantong'); // yuantong.png
    } else if (lowerCompany.includes('äº¬ä¸œ') || lowerCompany.includes('jd')) {
      return $r('app.media.jd'); // jd.png
    } else if (lowerCompany.includes('ç™¾ä¸–')) {
      return $r('app.media.baishiwuliu'); // baishiwuliu.png
    } else if (lowerCompany.includes('å¾·é‚¦')) {
      return $r('app.media.debangwuliu'); // debangwuliu.png
    } else if (lowerCompany.includes('å®‰èƒ½')) {
      return $r('app.media.annengwuliu'); // annengwuliu.png
    } else if (lowerCompany.includes('èœé¸Ÿ')) {
      return $r('app.media.cainiao');
    }
    return $r('app.media.startIcon'); // é»˜è®¤å›¾æ ‡
  }

  @Builder
  BottomTabBar() {
    Row() {
      // å¾…å–æ ‡ç­¾
      Column({ space: 4 }) {
        Text(this.currentTab === 0 ? 'ğŸ“¦' : 'ğŸ“¦')
          .fontSize(24)
        Text('å¾…å–')
          .fontSize(14)
          .fontColor(this.currentTab === 0 ?
            $r('app.color.primary_text') :
            $r('app.color.secondary_text'))
          .fontWeight(this.currentTab === 0 ? FontWeight.Bold : FontWeight.Normal)
      }
      .width('50%')
      .padding(12)
      .onClick(() => {
        this.onTabChange(0);
      })

      // å·²å–æ ‡ç­¾
      Column({ space: 4 }) {
        Text(this.currentTab === 1 ? 'âœ“' : 'âœ“')
          .fontSize(24)
        Text('å·²å–')
          .fontSize(14)
          .fontColor(this.currentTab === 1 ?
            $r('app.color.primary_text') :
            $r('app.color.secondary_text'))
          .fontWeight(this.currentTab === 1 ? FontWeight.Bold : FontWeight.Normal)
      }
      .width('50%')
      .padding(12)
      .onClick(() => {
        this.onTabChange(1);
      })
    }
    .width('100%')
    .height(64)
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: $r('app.color.divider_color') })
  }
}
