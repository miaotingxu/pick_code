import { ParcelModel } from '../model/ParcelModel';
import { ParcelDatabase } from '../database/ParcelDatabase';
import { Constants } from '../common/Constants';
import { ScanService } from '../service/ScanService';
import { IconUtils } from '../utils/IconUtils';
import { router } from '@kit.ArkUI';
import { pasteboard } from '@kit.BasicServicesKit';
import { promptAction } from '@kit.ArkUI';
import { common } from '@kit.AbilityKit';

@Entry
@Component
struct Index {
  @State currentTab: number = 0; // 0-å¾…å–, 1-å·²å–
  @State parcelList: ParcelModel[] = [];
  @State selectedSortMode: string = 'æŒ‰æ—¶é—´'; // æ’åºæ¨¡å¼ï¼š'æŒ‰æ—¶é—´' æˆ– 'æŒ‰å¿«é€’å…¬å¸'
  @State isEditMode: boolean = false;
  @State selectedParcels: Set<number> = new Set();
  @State groupedData: Map<string, ParcelModel[]> = new Map();
  private database: ParcelDatabase = ParcelDatabase.getInstance();
  private scanService: ScanService = ScanService.getInstance();
  private companySortOrder: string[] = []; // ä¿å­˜å¿«é€’å…¬å¸çš„æ’åºé¡ºåº

  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®åº“
    const context = getContext(this) as common.UIAbilityContext;
    await this.database.initDB(context);
    // åŠ è½½æµ‹è¯•æ•°æ®ï¼ˆé¦–æ¬¡è¿è¡Œæ—¶ï¼‰
    await this.loadTestData();
    // åŠ è½½æ•°æ®
    await this.loadParcels();
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°
  async onPageShow() {
    await this.loadParcels();
  }

  // åŠ è½½æµ‹è¯•æ•°æ®
  async loadTestData() {
    const existingData = await this.database.queryAllParcels();
    
    // ä¸´æ—¶å¼ºåˆ¶åŠ è½½æµ‹è¯•æ•°æ®ï¼ˆæµ‹è¯•å®Œè®°å¾—æ”¹å›æ¥ï¼ï¼‰
    if (existingData.length > 0) {
      console.info('æ£€æµ‹åˆ°å·²æœ‰æ•°æ®ï¼Œå…ˆæ¸…ç©ºæ—§æ•°æ®');
      // åˆ é™¤æ‰€æœ‰æ—§æ•°æ®
      for (const parcel of existingData) {
        if (parcel.id) {
          await this.database.deleteParcel(parcel.id);
        }
      }
    }
    
    // æ·»åŠ ä¸°å¯Œçš„æµ‹è¯•æ•°æ®ï¼ˆæ¯ä¸ªå¿«é€’å…¬å¸æ•°é‡ä¸åŒï¼Œæ–¹ä¾¿æµ‹è¯•æ’åºåŠŸèƒ½ï¼‰
    // å°† pickupTime è½¬æ¢ä¸ºä»Šå¤©å¯¹åº”æ—¶åˆ»çš„æ—¶é—´æˆ³
    const convertTimeToTimestamp = (timeStr: string): number => {
      const parts = timeStr.split(':');
      const hour = parseInt(parts[0]);
      const minute = parseInt(parts[1]);
      const now = new Date();
      now.setHours(hour, minute, 0, 0);
      return now.getTime();
    };
    
    const testParcels = [
        // é¡ºä¸°é€Ÿè¿ (2ä»¶)
        new ParcelModel('SF1234567890', 'é¡ºä¸°é€Ÿè¿', 'é¡ºä¸°ç«™ç‚¹', 'æ­å·æ–‡ä¸‰è·¯è¥ä¸šç‚¹', '18:45', 0),
        new ParcelModel('SF1234567891', 'é¡ºä¸°é€Ÿè¿', 'é¡ºä¸°ç«™ç‚¹', 'æ­å·æ–‡ä¸‰è·¯è¥ä¸šç‚¹', '17:55', 0),
        
        // ä¸­é€šå¿«é€’ (5ä»¶ - æ•°é‡æœ€å¤š)
        new ParcelModel('6-2-2175', 'ä¸­é€šå¿«é€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '18:30', 0),
        new ParcelModel('6-2-2176', 'ä¸­é€šå¿«é€’', 'å…”å–œç”Ÿæ´»', 'æ­å·è¥¿æ¹–åŒºæ–‡ä¸€è·¯åº—', '17:45', 0),
        new ParcelModel('6-2-2177', 'ä¸­é€šå¿«é€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '16:20', 0),
        new ParcelModel('6-2-2178', 'ä¸­é€šå¿«é€’', 'å¦ˆå¦ˆé©¿ç«™', 'æ­å·åŸè¥¿é“¶æ³°åº—', '15:30', 0),
        new ParcelModel('6-2-2179', 'ä¸­é€šå¿«é€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '14:15', 0),
        
        // äº¬ä¸œå¿«é€’ (2ä»¶)
        new ParcelModel('JD8888888888', 'äº¬ä¸œå¿«é€’', 'äº¬ä¸œè‡ªæç‚¹', 'æ­å·è¥¿æ¹–åŒºæ–‡ä¸€è·¯', '18:20', 0),
        new ParcelModel('JD8888888889', 'äº¬ä¸œå¿«é€’', 'äº¬ä¸œè‡ªæç‚¹', 'æ­å·è¥¿æ¹–åŒºæ–‡ä¸€è·¯', '16:30', 0),
        
        // åœ†é€šé€Ÿé€’ (4ä»¶)
        new ParcelModel('6-3-1234', 'åœ†é€šé€Ÿé€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '18:15', 0),
        new ParcelModel('6-3-1235', 'åœ†é€šé€Ÿé€’', 'å…”å–œç”Ÿæ´»', 'æ­å·è¥¿æ¹–åŒºæ–‡ä¸€è·¯åº—', '17:20', 0),
        new ParcelModel('6-3-1236', 'åœ†é€šé€Ÿé€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '16:45', 0),
        new ParcelModel('6-3-1237', 'åœ†é€šé€Ÿé€’', 'å¦ˆå¦ˆé©¿ç«™', 'æ­å·åŸè¥¿é“¶æ³°åº—', '15:50', 0),
        
        // æå…”é€Ÿé€’ (3ä»¶)
        new ParcelModel('2-5-2418', 'æå…”é€Ÿé€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '18:05', 0),
        new ParcelModel('2-5-2419', 'æå…”é€Ÿé€’', 'å…”å–œç”Ÿæ´»', 'æ­å·è¥¿æ¹–åŒºæ–‡ä¸€è·¯åº—', '17:30', 0),
        new ParcelModel('2-5-2420', 'æå…”é€Ÿé€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '16:10', 0),
        
        // éŸµè¾¾å¿«é€’ (1ä»¶)
        new ParcelModel('7-1-9876', 'éŸµè¾¾å¿«é€’', 'èœé¸Ÿé©¿ç«™', 'æ­å·ä¸‡æ³°å‡¤åæ–°å»ºåº—', '17:40', 0),
        
        // ç”³é€šå¿«é€’ (1ä»¶)
        new ParcelModel('8-2-5432', 'ç”³é€šå¿«é€’', 'å…”å–œç”Ÿæ´»', 'æ­å·è¥¿æ¹–åŒºæ–‡ä¸€è·¯åº—', '16:50', 0),
        
        // é‚®æ”¿å¿«é€’ (1ä»¶)
        new ParcelModel('EMS123456789', 'é‚®æ”¿å¿«é€’', 'é‚®æ”¿è¥ä¸šå…', 'æ­å·æ–‡ä¸‰è·¯é‚®å±€', '15:20', 0),
      ];

      // å°† pickupTimeï¼ˆå¦‚ '18:30'ï¼‰è½¬æ¢ä¸ºæ—¶é—´æˆ³å¹¶è®¾ç½®åˆ° createTime
      testParcels.forEach(parcel => {
        parcel.createTime = convertTimeToTimestamp(parcel.pickupTime);
      });

      for (const parcel of testParcels) {
        await this.database.insertParcel(parcel);
      }
      
      console.info('âœ… æµ‹è¯•æ•°æ®åŠ è½½å®Œæˆï¼šå…± ' + testParcels.length + ' æ¡è®°å½•');
      console.info('ğŸ“¦ ä¸­é€šå¿«é€’ï¼š5ä»¶ï¼Œåœ†é€šé€Ÿé€’ï¼š4ä»¶ï¼Œæå…”é€Ÿé€’ï¼š3ä»¶');
      console.info('ğŸ“¦ é¡ºä¸°é€Ÿè¿ï¼š2ä»¶ï¼Œäº¬ä¸œå¿«é€’ï¼š2ä»¶');
      console.info('ğŸ“¦ éŸµè¾¾å¿«é€’ï¼š1ä»¶ï¼Œç”³é€šå¿«é€’ï¼š1ä»¶ï¼Œé‚®æ”¿å¿«é€’ï¼š1ä»¶');
  }

  // åŠ è½½åŒ…è£¹æ•°æ®
  async loadParcels() {
    const status = this.currentTab === 0 ? Constants.STATUS_PENDING : Constants.STATUS_PICKED;
    this.parcelList = await this.database.queryParcelsByStatus(status);
    // æ›´æ–°åˆ†ç»„æ•°æ®
    this.groupedData = this.getGroupedParcels();
  }


  // åˆ‡æ¢æ ‡ç­¾é¡µ
  async onTabChange(index: number) {
    this.currentTab = index;
    this.isEditMode = false;
    this.selectedParcels.clear();
    this.companySortOrder = []; // æ¸…ç©ºæ’åºé¡ºåºï¼Œå› ä¸ºå¾…å–å’Œå·²å–çš„æ•°æ®ä¸åŒ
    await this.loadParcels();
  }

  // åˆ‡æ¢åŒ…è£¹çŠ¶æ€
  async toggleParcelStatus(parcel: ParcelModel) {
    if (parcel.id) {
      const newStatus = parcel.status === Constants.STATUS_PENDING ?
        Constants.STATUS_PICKED : Constants.STATUS_PENDING;
      await this.database.updateParcelStatus(parcel.id, newStatus);
      
      // æ·»åŠ å‹å¥½æç¤º
      if (newStatus === Constants.STATUS_PICKED) {
        promptAction.showToast({ 
          message: `${parcel.courierCompany} å·²æ ‡è®°ä¸ºå·²å–ï¼Œå¯åœ¨"å·²å–"æ ‡ç­¾æŸ¥çœ‹`, 
          duration: 2000 
        });
      } else {
        promptAction.showToast({ 
          message: `${parcel.courierCompany} å·²æ¢å¤åˆ°å¾…å–åˆ—è¡¨`, 
          duration: 2000 
        });
      }
      
      await this.loadParcels();
    }
  }

  // å¤åˆ¶å–ä»¶ç 
  async copyPickupCode(code: string) {
    try {
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, code);
      const systemPasteboard = pasteboard.getSystemPasteboard();
      await systemPasteboard.setData(pasteData);
      promptAction.showToast({ message: 'å–ä»¶ç å·²å¤åˆ¶', duration: 2000 });
    } catch (error) {
      console.error('Copy failed:', JSON.stringify(error));
    }
  }

  // åˆ é™¤é€‰ä¸­çš„åŒ…è£¹
  async deleteSelectedParcels() {
    const ids = Array.from(this.selectedParcels);
    if (ids.length > 0) {
      await this.database.batchDeleteParcels(ids);
      this.selectedParcels.clear();
      this.isEditMode = false;
      await this.loadParcels();
      promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ', duration: 2000 });
    }
  }

  // åˆ é™¤å•ä¸ªåŒ…è£¹ï¼ˆä¾§æ»‘åˆ é™¤ï¼‰
  async deleteSingleParcel(parcel: ParcelModel) {
    if (parcel.id) {
      await this.database.deleteParcel(parcel.id);
      await this.loadParcels();
      promptAction.showToast({ 
        message: `å·²åˆ é™¤ ${parcel.courierCompany} - ${parcel.pickupCode}`, 
        duration: 2000 
      });
    }
  }

  // æ¸…ç©ºæ‰€æœ‰å·²å–çš„åŒ…è£¹
  async clearAllPickedParcels() {
    if (this.parcelList.length === 0) {
      promptAction.showToast({ message: 'æ²¡æœ‰å¯æ¸…ç©ºçš„è®°å½•', duration: 2000 });
      return;
    }

    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    promptAction.showDialog({
      title: 'ç¡®è®¤æ¸…ç©º',
      message: `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²å–çš„è®°å½•å—ï¼Ÿå…± ${this.parcelList.length} æ¡è®°å½•å°†è¢«åˆ é™¤ã€‚`,
      buttons: [
        { text: 'å–æ¶ˆ', color: '#666666' },
        { text: 'ç¡®å®š', color: '#FF0000' }
      ]
    }).then(async (result) => {
      if (result.index === 1) {
        // ç”¨æˆ·ç‚¹å‡»äº†ç¡®å®š
        const ids = this.parcelList.map(p => p.id).filter(id => id !== undefined) as number[];
        if (ids.length > 0) {
          await this.database.batchDeleteParcels(ids);
          await this.loadParcels();
          promptAction.showToast({ 
            message: `å·²æ¸…ç©º ${ids.length} æ¡è®°å½•`, 
            duration: 2000 
          });
        }
      }
    }).catch((err: Error) => {
      console.error('Dialog error:', JSON.stringify(err));
    });
  }

  // è·³è½¬åˆ°æ·»åŠ é¡µé¢
  async navigateToAddPage() {
    await router.pushUrl({ url: 'pages/AddParcel' });
    // æ•°æ®åˆ·æ–°ç”± onPageShow() ç”Ÿå‘½å‘¨æœŸå¤„ç†
  }

  // ä»å‰ªè´´æ¿å¯¼å…¥çŸ­ä¿¡
  async importFromClipboard() {
    try {
      const systemPasteboard = pasteboard.getSystemPasteboard();
      const pasteData = await systemPasteboard.getData();
      
      if (pasteData && pasteData.getPrimaryText()) {
        const clipboardText = pasteData.getPrimaryText();
        // è·³è½¬åˆ°çŸ­ä¿¡å¯¼å…¥é¡µé¢
        await router.pushUrl({
          url: 'pages/SmsImport',
          params: {
            smsContent: clipboardText
          }
        });
      } else {
        promptAction.showToast({
          message: 'å‰ªè´´æ¿ä¸ºç©º',
          duration: 2000
        });
      }
    } catch (error) {
      console.error('Read clipboard failed:', JSON.stringify(error));
      promptAction.showToast({
        message: 'è¯»å–å‰ªè´´æ¿å¤±è´¥',
        duration: 2000
      });
    }
  }

  // è·å–å¿«é€’å…¬å¸å›¾æ ‡é¢œè‰²
  getCourierColor(company: string): string {
    return IconUtils.getCourierColor(company);
  }

  // è·å–å¿«é€’å…¬å¸ç¼©å†™
  getCourierAbbr(company: string): string {
    return IconUtils.getCourierAbbr(company);
  }

  // è·å–æ’åºåçš„åŒ…è£¹åˆ—è¡¨
  getSortedParcels(recomputeOrder: boolean = false): ParcelModel[] {
    if (this.selectedSortMode === 'æŒ‰æ—¶é—´') {
      // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
      return [...this.parcelList].sort((a, b) => b.createTime - a.createTime);
    } else {
      // æŒ‰å¿«é€’å…¬å¸æ’åº
      return this.sortParcelsByCompanyCount(this.parcelList, recomputeOrder);
    }
  }

  // æŒ‰æ—¥æœŸåˆ†ç»„
  getGroupedParcels(recomputeOrder: boolean = false): Map<string, ParcelModel[]> {
    const grouped = new Map<string, ParcelModel[]>();
    const sortedList = this.getSortedParcels(recomputeOrder);

    sortedList.forEach(parcel => {
      const date = new Date(parcel.createTime);
      const dateKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

      if (!grouped.has(dateKey)) {
        grouped.set(dateKey, []);
      }
      grouped.get(dateKey)?.push(parcel);
    });

    return grouped;
  }

  // æŒ‰å¿«é€’å…¬å¸å¾…å–ä»¶æ•°é‡æ’åºåŒ…è£¹åˆ—è¡¨
  sortParcelsByCompanyCount(parcels: ParcelModel[], recomputeOrder: boolean = false): ParcelModel[] {
    // 1. æŒ‰å¿«é€’å…¬å¸åˆ†ç»„
    const companyGroups = new Map<string, ParcelModel[]>();
    parcels.forEach(parcel => {
      const company = parcel.courierCompany;
      if (!companyGroups.has(company)) {
        companyGroups.set(company, []);
      }
      companyGroups.get(company)?.push(parcel);
    });

    // 2. å¯¹æ¯ä¸ªå¿«é€’å…¬å¸çš„åŒ…è£¹æŒ‰æ—¶é—´æ’åº
    companyGroups.forEach((parcels, company) => {
      parcels.sort((a, b) => b.createTime - a.createTime);
    });

    // 3. ç¡®å®šå¿«é€’å…¬å¸çš„é¡ºåº
    let sortedCompanies: string[] = [];
    
    if (recomputeOrder || this.companySortOrder.length === 0) {
      // éœ€è¦é‡æ–°è®¡ç®—é¡ºåºï¼šæŒ‰åŒ…è£¹æ•°é‡æ’åº
      const companyCount = new Map<string, number>();
      parcels.forEach(parcel => {
        const company = parcel.courierCompany;
        companyCount.set(company, (companyCount.get(company) || 0) + 1);
      });

      sortedCompanies = Array.from(companyGroups.keys()).sort((a, b) => {
        const countA = companyCount.get(a) || 0;
        const countB = companyCount.get(b) || 0;

        // æ•°é‡å¤šçš„æ’å‰é¢
        if (countA !== countB) {
          return countB - countA;
        }

        // æ•°é‡ç›¸åŒï¼ŒæŒ‰é¦–ä¸ªåŒ…è£¹çš„åˆ›å»ºæ—¶é—´æ’åº
        const parcelsA = companyGroups.get(a) || [];
        const parcelsB = companyGroups.get(b) || [];
        if (parcelsA.length > 0 && parcelsB.length > 0) {
          return parcelsB[0].createTime - parcelsA[0].createTime;
        }

        return 0;
      });

      // ä¿å­˜é¡ºåº
      this.companySortOrder = sortedCompanies;
    } else {
      // ä½¿ç”¨ä¿å­˜çš„é¡ºåºï¼Œä½†åªåŒ…å«å½“å‰å­˜åœ¨çš„å…¬å¸
      const currentCompanies = new Set(companyGroups.keys());
      sortedCompanies = this.companySortOrder.filter(company => currentCompanies.has(company));
      
      // æ·»åŠ æ–°å‡ºç°çš„å…¬å¸ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      currentCompanies.forEach(company => {
        if (!this.companySortOrder.includes(company)) {
          sortedCompanies.push(company);
        }
      });
    }

    // 4. ç»„åˆæ’åºåçš„ç»“æœ
    const sortedParcels: ParcelModel[] = [];
    sortedCompanies.forEach(company => {
      const companyParcels = companyGroups.get(company) || [];
      sortedParcels.push(...companyParcels);
    });

    return sortedParcels;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.TopBar()

      // ç­›é€‰åŒºåŸŸ
      if (this.currentTab === 0) {
        this.FilterBar()
      }

      // åˆ—è¡¨åŒºåŸŸ
      this.ParcelList()

      // åº•éƒ¨ TabBar
      this.BottomTabBar()
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_color'))
  }

  @Builder
  TopBar() {
    Row() {
      // å·¦ä¾§èœå•æŒ‰é’®
      Image($r('app.media.big_logo'))
        .width(24)
        .height(24)
        .margin({ left: 16 })

      // æ ‡é¢˜
      Text(this.currentTab === 0 ?
        `å¾…å–åŒ…è£¹ (${this.parcelList.length})` :
        'å–ä»¶è®°å½•')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .margin({ left: 16 })
        .layoutWeight(1)

      // å³ä¾§åŠŸèƒ½æŒ‰é’®
      Row({ space: 16 }) {
        // æ·»åŠ æŒ‰é’®
        Text('+')
          .fontSize(28)
          .fontWeight(FontWeight.Medium)
          .onClick(() => {
            this.navigateToAddPage();
          })

        // æ‰«ç æŒ‰é’®
        Text('âŠ')
          .fontSize(24)
          .fontWeight(FontWeight.Medium)
          .onClick(async () => {
            const context = getContext(this) as common.UIAbilityContext;
            await this.scanService.startScan(context);
            // æ‰«ç ååˆ·æ–°æ•°æ®
            await this.loadParcels();
          })

        // å¯¼å…¥æŒ‰é’®ï¼ˆå¾…å–é¡µé¢æ˜¾ç¤ºï¼‰
        if (this.currentTab === 0) {
          Text('ğŸ“‹')
            .fontSize(22)
            .fontWeight(FontWeight.Medium)
            .onClick(() => {
              this.importFromClipboard();
            })
        }

        // å·²å–é¡µé¢ï¼šæ¸…ç©ºå’Œåˆ é™¤æŒ‰é’®
        if (this.currentTab === 1) {
          Text('æ¸…ç©º')
            .fontSize(16)
            .fontColor($r('app.color.accent_blue'))
            .onClick(() => {
              this.clearAllPickedParcels();
            })
          
          Image($r('app.media.big_logo'))
            .width(24)
            .height(24)
            .onClick(() => {
              this.isEditMode = !this.isEditMode;
              if (!this.isEditMode) {
                this.selectedParcels.clear();
              }
            })
        }
      }
      .margin({ right: 16 })
    }
    .width('100%')
    .height(56)
    .backgroundColor(Color.White)
    .padding({ top: 10, bottom: 10 })
  }

  @Builder
  FilterBar() {
    Row() {
      // æ’åºæ¨¡å¼åˆ‡æ¢ï¼ˆä¸¤ä¸ªTABï¼‰
      Row({ space: 8 }) {
        // æŒ‰æ—¶é—´
        Text('æŒ‰æ—¶é—´')
          .fontSize(14)
          .fontColor(this.selectedSortMode === 'æŒ‰æ—¶é—´' ?
            $r('app.color.filter_button_active_text') :
            $r('app.color.filter_button_text'))
          .backgroundColor(this.selectedSortMode === 'æŒ‰æ—¶é—´' ?
            $r('app.color.filter_button_active_bg') :
            Color.Transparent)
          .border({
            width: this.selectedSortMode === 'æŒ‰æ—¶é—´' ? 0 : 1.5,
            color: this.selectedSortMode === 'æŒ‰æ—¶é—´' ? 
              Color.Transparent : 
              $r('app.color.tab_border_color')
          })
          .borderRadius(8)
          .padding({
            left: 16,
            right: 16,
            top: 8,
            bottom: 8
          })
          .onClick(() => {
            this.selectedSortMode = 'æŒ‰æ—¶é—´';
            this.groupedData = this.getGroupedParcels(false);
          })

        // æŒ‰å¿«é€’å…¬å¸
        Text('æŒ‰å¿«é€’å…¬å¸')
          .fontSize(14)
          .fontColor(this.selectedSortMode === 'æŒ‰å¿«é€’å…¬å¸' ?
            $r('app.color.filter_button_active_text') :
            $r('app.color.filter_button_text'))
          .backgroundColor(this.selectedSortMode === 'æŒ‰å¿«é€’å…¬å¸' ?
            $r('app.color.filter_button_active_bg') :
            Color.Transparent)
          .border({
            width: this.selectedSortMode === 'æŒ‰å¿«é€’å…¬å¸' ? 0 : 1.5,
            color: this.selectedSortMode === 'æŒ‰å¿«é€’å…¬å¸' ? 
              Color.Transparent : 
              $r('app.color.tab_border_color')
          })
          .borderRadius(8)
          .padding({
            left: 16,
            right: 16,
            top: 8,
            bottom: 8
          })
          .onClick(() => {
            this.selectedSortMode = 'æŒ‰å¿«é€’å…¬å¸';
            this.groupedData = this.getGroupedParcels(true); // åˆ‡æ¢åˆ°"æŒ‰å¿«é€’å…¬å¸"æ—¶é‡æ–°æ’åº
          })
      }
      .padding({ left: 16 })
      .layoutWeight(1)

      // å‹¾é€‰æ¡†ï¼ˆå³ä¾§ï¼‰
      Checkbox()
        .width(24)
        .height(24)
        .margin({ right: 16 })
    }
    .width('100%')
    .padding({ top: 12, bottom: 12 })
    .backgroundColor(Color.White)
  }

  @Builder
  ParcelList() {
    if (this.parcelList.length === 0) {
      // ç©ºçŠ¶æ€æç¤º
      this.EmptyState()
    } else {
      List({ space: 0 }) {
        ForEach(Array.from(this.groupedData.keys()), (date: string) => {
          ListItemGroup({ header: this.DateHeader(date, this.groupedData.get(date)?.length || 0) }) {
            ForEach(this.groupedData.get(date) || [], (parcel: ParcelModel) => {
              ListItem() {
                this.ParcelCard(parcel)
              }
              .swipeAction({ end: this.DeleteButton(parcel) })
            }, (parcel: ParcelModel) => parcel.id?.toString() || '')
          }
        }, (date: string) => date)
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor($r('app.color.background_color'))
      .padding({ left: 16, right: 16 })
    }
  }

  @Builder
  EmptyState() {
    Column({ space: 16 }) {
      // ç©ºçŠ¶æ€å›¾æ ‡
      Text('ğŸ“¦')
        .fontSize(80)
        .margin({ top: 100 })

      // æç¤ºæ–‡å­—
      Text(this.getEmptyStateText())
        .fontSize(16)
        .fontColor($r('app.color.secondary_text'))
        .textAlign(TextAlign.Center)

      // æ“ä½œå»ºè®®ï¼ˆä»…å¾…å–é¡µé¢æ˜¾ç¤ºï¼‰
      if (this.currentTab === 0) {
        Column({ space: 12 }) {
          Text('ç‚¹å‡»å³ä¸Šè§’ + å·æ·»åŠ å–ä»¶ç ')
            .fontSize(14)
            .fontColor($r('app.color.accent_blue'))

          Text('æˆ–ç‚¹å‡»æ‰«ç å›¾æ ‡æ‰«æå¿«é€’å•')
            .fontSize(14)
            .fontColor($r('app.color.secondary_text'))
        }
        .margin({ top: 12 })
      }
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .backgroundColor($r('app.color.background_color'))
  }

  // è·å–ç©ºçŠ¶æ€æç¤ºæ–‡å­—
  getEmptyStateText(): string {
    return this.currentTab === 0 ?
      'æš‚æ— å¾…å–çš„å¿«é€’åŒ…è£¹' :
      'æš‚æ— å·²å–çš„å¿«é€’è®°å½•';
  }

  @Builder
  DateHeader(date: string, count: number) {
    Row() {
      Text(date)
        .fontSize(14)
        .fontColor($r('app.color.secondary_text'))

      Blank()

      Text(`${count}æ¡è®°å½•`)
        .fontSize(14)
        .fontColor($r('app.color.secondary_text'))
    }
    .width('100%')
    .padding({ top: 12, bottom: 8 })
  }

  @Builder
  DeleteButton(parcel: ParcelModel) {
    Row() {
      Text('åˆ é™¤')
        .fontSize(16)
        .fontColor(Color.White)
        .fontWeight(FontWeight.Medium)
    }
    .width(80)
    .height('100%')
    .backgroundColor(Color.Red)
    .justifyContent(FlexAlign.Center)
    .borderRadius(12)
    .margin({ top: 6, bottom: 6 })
    .onClick(() => {
      this.deleteSingleParcel(parcel);
    })
  }

  @Builder
  ParcelCard(parcel: ParcelModel) {
    Row() {
      // å·¦ä¾§ï¼šå¿«é€’å…¬å¸å›¾æ ‡ï¼ˆæ­£æ–¹å½¢å¸¦åœ†è§’ï¼‰
      this.CourierIconView(parcel.courierCompany, parcel.status)

      // ä¸­é—´ï¼šä¿¡æ¯åŒºåŸŸ
      Column({ space: 4 }) {
        // å¿«é€’å…¬å¸åç§°ï¼ˆæ ‡é¢˜ï¼‰
        Text(parcel.courierCompany)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(parcel.status === Constants.STATUS_PICKED ?
            $r('app.color.secondary_text') :
            $r('app.color.primary_text'))

        // é©¿ç«™åç§°å’Œåœ°å€
        Text(`${parcel.stationName} Â· ${parcel.address}`)
          .fontSize(13)
          .fontColor($r('app.color.secondary_text'))
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .opacity(parcel.status === Constants.STATUS_PICKED ? 0.6 : 1)

        // å–ä»¶ç ï¼ˆå¤§å·å­—ä½“ï¼Œæ”¯æŒé•¿å•å·è‡ªé€‚åº”ï¼‰
        Text(parcel.pickupCode)
          .fontSize(24)
          .minFontSize(18)
          .maxLines(1)
          .fontWeight(FontWeight.Bold)
          .fontColor(parcel.status === Constants.STATUS_PICKED ?
            $r('app.color.secondary_text') :
            $r('app.color.primary_text'))
          .decoration({
            type: parcel.status === Constants.STATUS_PICKED ?
              TextDecorationType.LineThrough :
              TextDecorationType.None
          })
          .letterSpacing(1)
          .margin({ top: 4 })
          .textOverflow({ overflow: TextOverflow.Clip })
          .gesture(
            LongPressGesture()
              .onAction(() => {
                this.copyPickupCode(parcel.pickupCode);
              })
          )
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // å³ä¾§ï¼šæ—¶é—´å’ŒçŠ¶æ€
      Column({ space: 8 }) {
        Text(`${parcel.pickupTime} ${this.currentTab === 0 ? '' : 'å–ä»¶'}`)
          .fontSize(13)
          .fontColor($r('app.color.primary_text'))
          .opacity(parcel.status === Constants.STATUS_PICKED ? 0.6 : 0.85)

        // å‹¾é€‰æ¡†
        if (this.currentTab === 0) {
          // å¾…å–ï¼šåœ†å½¢æ¡†
          Circle({ width: 24, height: 24 })
            .fill(Color.Transparent)
            .stroke($r('app.color.divider_color'))
            .strokeWidth(2)
            .onClick(() => {
              this.toggleParcelStatus(parcel);
            })
        } else {
          // å·²å–ï¼šè“è‰²å‹¾é€‰
          Stack() {
            Circle({ width: 24, height: 24 })
              .fill($r('app.color.accent_blue'))
            Text('âœ“')
              .fontSize(16)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
          }
          .onClick(() => {
            this.toggleParcelStatus(parcel);
          })
        }
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .padding(16)
    .margin({ top: 6, bottom: 6 })
    .shadow({ 
      radius: 8, 
      color: '#15000000', 
      offsetX: 0, 
      offsetY: 2 
    })
    .border({
      width: 1,
      color: parcel.status === Constants.STATUS_PICKED ? 
        $r('app.color.divider_color') : 
        Color.Transparent
    })
  }

  // å¿«é€’å…¬å¸å›¾æ ‡ç»„ä»¶ï¼ˆæ™ºèƒ½æ˜¾ç¤ºçœŸå®å›¾æ ‡æˆ–æ–‡å­—å›¾æ ‡ï¼‰
  @Builder
  CourierIconView(company: string, status: number) {
    Stack() {
      // åº•å±‚ï¼šå½©è‰²èƒŒæ™¯ + æ–‡å­—å›¾æ ‡ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
      Stack() {
        Text(this.getCourierAbbr(company))
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .textShadow({ radius: 2, color: '#40000000', offsetX: 0, offsetY: 1 })
      }
      .width(48)
      .height(48)
      .backgroundColor(this.getCourierColor(company))
      .borderRadius(8)
      
      // é¡¶å±‚ï¼šçœŸå®å›¾æ ‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      Image(this.getCourierIconResource(company))
        .width(48)
        .height(48)
        .borderRadius(8)
        .objectFit(ImageFit.Cover)
    }
    .width(48)
    .height(48)
    .opacity(status === Constants.STATUS_PICKED ? 0.5 : 1)
    .margin({ right: 12 })
  }

  // è·å–å¿«é€’å…¬å¸å›¾æ ‡èµ„æº
  getCourierIconResource(company: string): Resource {
    const lowerCompany = company.toLowerCase();

    // åŒ¹é… AppScope/resources/base/media ç›®å½•ä¸‹çš„çœŸå®å›¾æ ‡
    if (lowerCompany.includes('é¡ºä¸°') || lowerCompany.includes('sf')) {
      return $r('app.media.shunfeng'); // shunfeng.png
    } else if (lowerCompany.includes('ä¸­é€š') || lowerCompany.includes('zto')) {
      return $r('app.media.zhongtong'); // zhongtong.png
    } else if (lowerCompany.includes('ç”³é€š') || lowerCompany.includes('sto')) {
      return $r('app.media.shentong'); // shentong.png
    } else if (lowerCompany.includes('éŸµè¾¾')) {
      return $r('app.media.yunda'); // yunda.png
    } else if (lowerCompany.includes('æå…”') || lowerCompany.includes('jt') || lowerCompany.includes('j&t')) {
      return $r('app.media.jtexpress'); // jtexpress.png
    } else if (lowerCompany.includes('é‚®æ”¿') || lowerCompany.includes('ems')) {
      return $r('app.media.youzhengguonei'); // youzhengguonei.png
    } else if (lowerCompany.includes('åœ†é€š') || lowerCompany.includes('yto')) {
      return $r('app.media.yuantong'); // yuantong.png
    } else if (lowerCompany.includes('äº¬ä¸œ') || lowerCompany.includes('jd')) {
      return $r('app.media.jd'); // jd.png
    } else if (lowerCompany.includes('ç™¾ä¸–')) {
      return $r('app.media.baishiwuliu'); // baishiwuliu.png
    } else if (lowerCompany.includes('å¾·é‚¦')) {
      return $r('app.media.debangwuliu'); // debangwuliu.png
    } else if (lowerCompany.includes('å®‰èƒ½')) {
      return $r('app.media.annengwuliu'); // annengwuliu.png
    } else if (lowerCompany.includes('èœé¸Ÿ')) {
      return $r('app.media.cainiao');
    }
    return $r('app.media.big_logo'); // é»˜è®¤å›¾æ ‡
  }

  @Builder
  BottomTabBar() {
    Row() {
      // å¾…å–æ ‡ç­¾
      Column({ space: 4 }) {
        Text(this.currentTab === 0 ? 'ğŸ“¦' : 'ğŸ“¦')
          .fontSize(24)
        Text('å¾…å–')
          .fontSize(14)
          .fontColor(this.currentTab === 0 ?
            $r('app.color.primary_text') :
            $r('app.color.secondary_text'))
          .fontWeight(this.currentTab === 0 ? FontWeight.Bold : FontWeight.Normal)
      }
      .width('50%')
      .padding(12)
      .onClick(() => {
        this.onTabChange(0);
      })

      // å·²å–æ ‡ç­¾
      Column({ space: 4 }) {
        Stack() {
          Circle({ width: 24, height: 24 })
            .fill(this.currentTab === 1 ? $r('app.color.accent_blue') : '#A0A0A0')
          Text('âœ“')
            .fontSize(16)
            .fontColor(Color.White)
            .fontWeight(FontWeight.Bold)
        }
        Text('å·²å–')
          .fontSize(14)
          .fontColor(this.currentTab === 1 ?
            $r('app.color.primary_text') :
            '#666666')
          .fontWeight(this.currentTab === 1 ? FontWeight.Bold : FontWeight.Normal)
      }
      .width('50%')
      .padding(12)
      .onClick(() => {
        this.onTabChange(1);
      })
    }
    .width('100%')
    .height(64)
    .backgroundColor(Color.White)
    .border({ width: { top: 1 }, color: $r('app.color.divider_color') })
  }
}
