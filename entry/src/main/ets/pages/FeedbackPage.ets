/**
 * ç”¨æˆ·åé¦ˆé¡µé¢
 */
import { FeedbackService, FeedbackData } from '../service/FeedbackService';
import { router } from '@kit.ArkUI';
import { promptAction } from '@kit.ArkUI';

// åé¦ˆç±»åž‹æŽ¥å£
interface FeedbackTypeItem {
  id: string;
  label: string;
  description: string;
}

@Entry
@Component
struct FeedbackPage {
  @State feedbackContent: string = '';
  @State contactInfo: string = '';
  @State selectedType: string = 'other'; // 'bug' | 'feature' | 'other'
  @State isSubmitting: boolean = false;
  
  private feedbackService: FeedbackService = FeedbackService.getInstance();
  
  // åé¦ˆç±»åž‹é€‰é¡¹
  private feedbackTypes: FeedbackTypeItem[] = [
    { id: 'bug', label: 'ðŸ› Bugåé¦ˆ', description: 'åŠŸèƒ½å¼‚å¸¸æˆ–é”™è¯¯' },
    { id: 'feature', label: 'ðŸ’¡ åŠŸèƒ½å»ºè®®', description: 'æ–°åŠŸèƒ½æˆ–æ”¹è¿›å»ºè®®' },
    { id: 'other', label: 'ðŸ’¬ å…¶ä»–åé¦ˆ', description: 'ä½¿ç”¨ä½“éªŒæˆ–å…¶ä»–é—®é¢˜' }
  ];

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      this.buildTitleBar();
      
      Scroll() {
        Column() {
          // åé¦ˆç±»åž‹é€‰æ‹©
          this.buildTypeSelector();
          
          // åé¦ˆå†…å®¹è¾“å…¥
          this.buildContentInput();
          
          // è”ç³»æ–¹å¼è¾“å…¥
          this.buildContactInput();
          
          // æç¤ºä¿¡æ¯
          this.buildTips();
          
          // æäº¤æŒ‰é’®
          this.buildSubmitButton();
        }
        .padding({ left: 16, right: 16, bottom: 20 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // æ ‡é¢˜æ 
  @Builder
  buildTitleBar() {
    Row() {
      Text('â†')
        .fontSize(24)
        .fontColor(Color.Black)
        .width(32)
        .height(32)
        .textAlign(TextAlign.Center)
        .onClick(() => {
          router.back();
        })
      
      Text('æ„è§åé¦ˆ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      // å ä½ï¼Œä¿æŒå±…ä¸­
      Row().width(32).height(32)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.White)
  }

  // åé¦ˆç±»åž‹é€‰æ‹©å™¨
  @Builder
  buildTypeSelector() {
    Column() {
      Text('åé¦ˆç±»åž‹')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)
      
      ForEach(this.feedbackTypes, (type: FeedbackTypeItem) => {
        Row() {
          Column() {
            Text(type.label)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
            
            Text(type.description)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ top: 4 })
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
          
          Radio({ value: type.id, group: 'feedbackType' })
            .checked(this.selectedType === type.id)
            .onChange((isChecked: boolean) => {
              if (isChecked) {
                this.selectedType = type.id;
              }
            })
        }
        .width('100%')
        .padding(12)
        .margin({ bottom: 8 })
        .backgroundColor(this.selectedType === type.id ? '#E8F4FF' : Color.White)
        .borderRadius(8)
        .border({
          width: 1,
          color: this.selectedType === type.id ? '#1890FF' : '#EEEEEE'
        })
        .onClick(() => {
          this.selectedType = type.id;
        })
      }, (type: FeedbackTypeItem) => type.id)
    }
    .width('100%')
    .margin({ top: 16 })
  }

  // åé¦ˆå†…å®¹è¾“å…¥
  @Builder
  buildContentInput() {
    Column() {
      Text('åé¦ˆå†…å®¹')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)
      
      TextArea({ 
        placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜æˆ–å»ºè®®...\næˆ‘ä»¬ä¼šè®¤çœŸå¯¹å¾…æ¯ä¸€æ¡åé¦ˆ ðŸ˜Š'
      })
        .width('100%')
        .height(180)
        .fontSize(15)
        .padding(12)
        .backgroundColor(Color.White)
        .borderRadius(8)
        .maxLength(500)
        .onChange((value: string) => {
          this.feedbackContent = value;
        })
      
      Row() {
        Text(`${this.feedbackContent.length}/500`)
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      .justifyContent(FlexAlign.End)
      .margin({ top: 4 })
    }
    .width('100%')
    .margin({ top: 20 })
  }

  // è”ç³»æ–¹å¼è¾“å…¥
  @Builder
  buildContactInput() {
    Column() {
      Text('è”ç³»æ–¹å¼ï¼ˆé€‰å¡«ï¼‰')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 12 })
        .alignSelf(ItemAlign.Start)
      
      TextInput({ 
        placeholder: 'å¾®ä¿¡/QQ/é‚®ç®±ï¼ˆæ–¹ä¾¿æˆ‘ä»¬ä¸Žæ‚¨æ²Ÿé€šï¼‰'
      })
        .width('100%')
        .height(48)
        .fontSize(15)
        .padding({ left: 12, right: 12 })
        .backgroundColor(Color.White)
        .borderRadius(8)
        .onChange((value: string) => {
          this.contactInfo = value;
        })
    }
    .width('100%')
    .margin({ top: 20 })
  }

  // æç¤ºä¿¡æ¯
  @Builder
  buildTips() {
    Row() {
      Text('â„¹ï¸')
        .fontSize(16)
        .margin({ right: 8 })
      
      Text('æ‚¨çš„åé¦ˆå¯¹æˆ‘ä»¬éžå¸¸é‡è¦ï¼Œæ„Ÿè°¢æ”¯æŒï¼')
        .fontSize(13)
        .fontColor('#FF9800')
    }
    .width('100%')
    .padding(12)
    .margin({ top: 20 })
    .backgroundColor('#FFF3E0')
    .borderRadius(8)
  }

  // æäº¤æŒ‰é’®
  @Builder
  buildSubmitButton() {
    Button('æäº¤åé¦ˆ')
      .width('100%')
      .height(48)
      .fontSize(16)
      .fontWeight(FontWeight.Bold)
      .margin({ top: 30 })
      .enabled(!this.isSubmitting && this.feedbackContent.trim().length > 0)
      .backgroundColor(
        (!this.isSubmitting && this.feedbackContent.trim().length > 0) 
          ? '#1890FF' 
          : '#CCCCCC'
      )
      .onClick(() => {
        this.handleSubmit();
      })
    
    if (this.isSubmitting) {
      Row() {
        LoadingProgress()
          .width(20)
          .height(20)
          .color('#1890FF')
          .margin({ right: 8 })
        
        Text('æ­£åœ¨æäº¤...')
          .fontSize(14)
          .fontColor('#666666')
      }
      .margin({ top: 12 })
    }
  }

  // å¤„ç†æäº¤
  async handleSubmit() {
    if (this.feedbackContent.trim().length === 0) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥åé¦ˆå†…å®¹',
        duration: 2000
      });
      return;
    }

    this.isSubmitting = true;

    const feedbackData = new FeedbackData();
    feedbackData.content = this.feedbackContent.trim();
    feedbackData.contact = this.contactInfo.trim();
    feedbackData.type = this.selectedType;

    const success = await this.feedbackService.sendFeedback(feedbackData);

    this.isSubmitting = false;

    if (success) {
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      AlertDialog.show({
        title: 'æäº¤æˆåŠŸï¼',
        message: 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç† ðŸŽ‰',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {
            // æ¸…ç©ºè¡¨å•
            this.feedbackContent = '';
            this.contactInfo = '';
            this.selectedType = 'other';
            // è¿”å›žä¸Šä¸€é¡µ
            router.back();
          }
        }
      });
    } else {
      // æ˜¾ç¤ºå¤±è´¥æç¤º
      AlertDialog.show({
        title: 'æäº¤å¤±è´¥',
        message: 'ç½‘ç»œè¿žæŽ¥å¼‚å¸¸ï¼Œè¯·ç¨åŽé‡è¯•',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
    }
  }
}

