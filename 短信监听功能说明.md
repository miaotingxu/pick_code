# 短信监听与自动识别功能说明

## 🎯 功能概述

"取件助手"现在支持多种方式识别快递短信并自动添加取件码：

### ✅ 已实现功能

1. **短信分享导入** ⭐
   - 长按短信 → 分享到"取件助手"
   - 自动识别并添加

2. **剪贴板导入** ⭐
   - 复制短信内容
   - 点击📋按钮快速导入

3. **通知监听（实验性）** ⚠️
   - 监听系统通知栏的快递短信
   - 自动发送添加提醒
   - **需要系统级权限，可能无法使用**

---

## 📱 推荐使用方式

### 方式 1：短信分享（最推荐）

**优势**：
- ✅ 系统原生支持
- ✅ 最快捷方便
- ✅ 无需额外权限

**使用步骤**：
```
收到快递短信
  ↓
长按短信内容
  ↓
选择"分享"
  ↓
选择"取件助手"
  ↓
自动识别并保存
```

### 方式 2：剪贴板导入

**优势**：
- ✅ 简单快速
- ✅ 适用性广
- ✅ 可批量处理

**使用步骤**：
```
复制短信内容
  ↓
打开"取件助手"
  ↓
点击📋按钮
  ↓
自动识别并保存
```

---

## 🔍 智能识别能力

### 支持的短信格式

#### 格式 1：标准格式
```
【中通快递】您的快递已到达菜鸟驿站
取件码：6-2-2175
地址：杭州万泰凤华新建店
```
**识别结果**：
- 取件码：`6-2-2175`
- 快递公司：`中通快递`
- 驿站：`菜鸟驿站`
- 地址：`杭州万泰凤华新建店`

#### 格式 2：长单号格式
```
【顺丰速运】您的快递已到达顺丰站点
取件码：SF1234567890
地址：杭州文三路营业点
```
**识别结果**：
- 取件码：`SF1234567890`
- 快递公司：`顺丰速运`
- 驿站：`顺丰站点`

#### 格式 3：简化格式
```
【极兔速递】取件码：2-5-2418
兔喜生活-杭州西湖区文一路店
```
**识别结果**：
- 取件码：`2-5-2418`
- 快递公司：`极兔速递`
- 驿站：`兔喜生活`

### 识别关键词列表

| 类型 | 关键词 |
|------|--------|
| **取件码标识** | 取件码、验证码 |
| **快递公司** | 顺丰、中通、圆通、申通、韵达、极兔、京东、邮政、EMS、百世、德邦 |
| **驿站类型** | 菜鸟驿站、兔喜生活、妈妈驿站、超市、店 |
| **地址标识** | 地址： |

---

## ⚠️ 通知监听功能说明

### 功能原理
应用尝试监听系统通知栏的短信通知，当检测到快递相关短信时：
1. 自动解析短信内容
2. 识别取件码和快递公司
3. 发送应用通知提醒用户
4. 点击通知快速添加

### 限制说明

#### 权限限制
- 需要 `NOTIFICATION_CONTROLLER` 权限
- 这是**系统级权限**，普通应用可能无法获取
- 部分 HarmonyOS 设备可能不支持

#### 兼容性
- ✅ HarmonyOS NEXT 系统应用
- ⚠️ 普通第三方应用（可能不可用）
- ❌ 部分设备不支持

#### 解决方案
如果通知监听不可用，请使用：
- ✅ **方式 1：短信分享导入**（推荐）
- ✅ **方式 2：剪贴板导入**

---

## 🔐 权限说明

### 已申请的权限

| 权限 | 用途 | 状态 |
|------|------|------|
| `READ_MESSAGES` | 读取短信内容 | ✅ 正常 |
| `NOTIFICATION_CONTROLLER` | 监听通知 | ⚠️ 可能无法使用 |

### 权限使用说明

#### READ_MESSAGES
- **用途**：自动解析短信内容
- **使用场景**：
  - 用户分享短信到应用时
  - 用户使用剪贴板导入时
- **不会**：后台读取所有短信

#### NOTIFICATION_CONTROLLER
- **用途**：监听系统通知
- **使用场景**：
  - 实时监听快递短信通知
  - 发送添加提醒
- **限制**：系统级权限，可能无法获取

---

## 💡 最佳实践

### 推荐工作流

#### 场景 1：收到新快递短信
```
收到短信 → 长按分享 → 选择"取件助手" → 自动添加 ✅
```
**时间**：5秒内完成

#### 场景 2：批量导入历史短信
```
打开短信应用 → 找到快递短信 → 逐条复制 → 点击📋导入 ✅
```
**时间**：每条约10秒

#### 场景 3：他人转发的取件信息
```
微信/QQ收到信息 → 复制内容 → 打开应用 → 📋导入 ✅
```

### 提高识别率的技巧

1. **完整复制短信内容**
   - 不要截取部分内容
   - 包含快递公司、取件码、地址等完整信息

2. **确保包含关键词**
   - 必须包含"取件码"或"验证码"
   - 包含快递公司名称

3. **格式规范**
   - 取件码格式：`X-X-XXXX` 或长单号

---

## 📊 功能对比

| 功能 | 便捷性 | 可用性 | 准确性 | 推荐度 |
|------|--------|--------|--------|--------|
| 短信分享 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅✅✅ |
| 剪贴板导入 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅✅ |
| 通知监听 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ | ⚠️ |
| 手动输入 | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ |
| 扫码 | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅✅ |

---

## 🐛 常见问题

### Q1: 通知监听功能不可用？
**A**: 这是正常的。`NOTIFICATION_CONTROLLER` 是系统级权限，普通应用无法获取。

**解决方案**：
- 使用"短信分享"功能（推荐）
- 使用"剪贴板导入"功能

### Q2: 如何批量导入历史短信？
**A**: 
1. 打开短信应用
2. 找到快递短信
3. 逐条复制
4. 在"取件助手"中点击📋导入

### Q3: 识别失败怎么办？
**A**: 
1. 检查短信是否包含"取件码"关键词
2. 检查取件码格式是否正确
3. 手动修改识别结果或使用手动添加

### Q4: 是否会后台读取我的短信？
**A**: 
**不会！** 应用只会在以下情况处理短信：
- 用户主动分享短信到应用
- 用户主动使用剪贴板导入
- 用户明确授权后的通知监听（实验性，可能不可用）

### Q5: 支持哪些快递公司？
**A**: 
目前支持 **11家** 主流快递公司：
- 顺丰速运
- 中通快递
- 圆通速递
- 申通快递
- 韵达快递
- 极兔速递
- 京东快递
- 邮政快递/EMS
- 百世快递
- 德邦快递
- 安能物流

---

## 🔧 技术实现

### 短信解析引擎

```typescript
parseSmsContent(content: string): ParcelModel | null {
  // 1. 正则匹配取件码
  const pickupCodePattern = /取件码[：:]\s*(\d+-\d+-\d+)/i;
  const longCodePattern = /[A-Z]{2}\d{10,}/;
  
  // 2. 识别快递公司（关键词匹配）
  for (const company of COURIER_COMPANIES) {
    if (content.includes(company.keyword)) {
      courierCompany = company.name;
      break;
    }
  }
  
  // 3. 提取驿站名称
  const stationPattern = /在(.+?驿站)/;
  
  // 4. 提取地址
  const addressPattern = /地址[：:]\s*(.+?)(?:[，。]|$)/;
  
  // 5. 生成 ParcelModel
  return new ParcelModel(...);
}
```

### 通知监听（实验性）

```typescript
startNotificationListener(callback) {
  const subscriber = {
    onConsume: (data) => {
      // 检测到短信通知
      if (isDeliveryNotification(data.content)) {
        // 解析并回调
        callback(smsContent);
      }
    }
  };
  
  await notificationSubscribe.subscribe(subscriber);
}
```

---

## 🚀 未来计划

### 短期优化
- [x] 短信分享导入
- [x] 剪贴板导入
- [x] 智能识别引擎
- [ ] 批量导入界面
- [ ] 识别准确率优化

### 长期计划
- [ ] OCR 图片识别
- [ ] 语音输入取件码
- [ ] 云端同步
- [ ] 智能推荐取件路线

---

## 📝 开发者说明

### 为什么不能实时监听所有短信？

**安全性考虑**：
- HarmonyOS 保护用户隐私
- 防止应用滥用短信读取权限
- 避免后台常驻占用资源

**我们的做法**：
- ✅ 用户主动分享（最安全）
- ✅ 用户主动导入（可控）
- ⚠️ 通知监听（需授权，可能不可用）

### 如何提高识别准确率？

1. **丰富正则表达式**
2. **扩充快递公司关键词库**
3. **优化驿站名称提取算法**
4. **添加用户反馈机制**

---

## 💬 反馈与支持

如果你在使用中遇到问题或有改进建议，欢迎反馈！

**优先推荐使用**：
- ✅ 短信分享导入
- ✅ 剪贴板导入

这两种方式最稳定、最可靠！




