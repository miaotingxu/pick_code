# 扫码功能开发日志

## 更新时间
2025-10-24

## 功能概述
实现了完整的快递单扫码功能，支持通过扫描快递单上的条形码或二维码，自动识别物流单号和快递公司，并保存到本地数据库。

## 更新内容

### 1. 权限配置
**文件**: `entry/src/main/module.json5`
- ✅ 添加相机权限 `ohos.permission.CAMERA`
- ✅ 配置权限使用场景和说明

**文件**: `entry/src/main/resources/base/element/string.json`
- ✅ 添加权限描述文本 `permission_camera`

### 2. 核心功能实现
**文件**: `entry/src/main/ets/service/ScanService.ets`

#### 主要方法

1. **`startScan(context)`** - 启动扫码
   - 调用 HarmonyOS ScanKit API
   - 配置扫码选项（支持所有格式、支持相册选择）
   - 处理扫码结果和错误

2. **`processScanResult(content)`** - 处理扫码结果
   - 解析扫码内容
   - 保存到数据库
   - 更新快递公司和驿站使用历史
   - 显示成功或失败提示

3. **`parseBarcode(content)`** - 解析条码内容
   - 识别快递公司
   - 提取物流单号
   - 提取驿站信息

4. **`identifyCourier(content)`** - 识别快递公司
   - 通过关键词匹配（优先）
   - 通过单号格式特征识别

5. **`extractTrackingNumber(content, company)`** - 提取物流单号
   - 优先识别取件码格式（如：6-2-2175）
   - 识别完整物流单号（针对不同快递公司）
   - 通用数字单号匹配

6. **`extractStationInfo(content)`** - 提取驿站信息
   - 识别驿站名称（菜鸟、兔喜、妈妈等）
   - 提取地址信息

### 3. 识别规则

#### 取件码格式
```
6-2-2175    # 中通快递
2-5-2418    # 极兔速递
6-3-1234    # 圆通速递
```

#### 完整物流单号
```
SF1234567890        # 顺丰：12位数字
JD8888888888        # 京东：JD + 10-15位数字
EA123456789CN       # 邮政：国际格式
7123456789012       # 其他：10-20位数字
```

#### 快递公司识别
支持 15+ 主流快递公司：
- 顺丰速运、中通快递、申通快递
- 韵达快递、极兔速递、圆通速递
- 京东快递、邮政快递（EMS）
- 百世快递、德邦快递、安能物流
- 菜鸟驿站、妈妈驿站、兔喜生活

### 4. 用户交互

#### 扫码流程
```
点击扫码按钮 → 请求相机权限 → 打开扫码界面 → 扫描条码 → 自动识别 → 保存数据 → 刷新列表
```

#### 错误处理
- 用户取消扫码：静默处理，不显示错误
- 扫码失败：提示重试
- 识别失败：提示手动添加
- 保存失败：提示重试

#### 成功提示
显示格式：`添加成功：{快递公司} - {取件码}`
例如：`添加成功：中通快递 - 6-2-2175`

### 5. 技术实现

#### 依赖模块
```typescript
import { scanBarcode, scanCore } from '@kit.ScanKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';
```

#### 扫码配置
```typescript
const options: scanBarcode.ScanOptions = {
  scanTypes: [scanCore.ScanType.ALL],  // 支持所有格式
  enableMultiMode: false,               // 单次扫描
  enableAlbum: true                     // 支持相册
};
```

#### 正则表达式
```typescript
// 取件码格式
/(\d+-\d+-\d+)/

// 顺丰单号
/SF\d{12}|\d{12}/i

// 京东单号
/JD\d{10,15}/i

// 邮政单号
/E\w{12}CN|[A-Z]{2}\d{9}[A-Z]{2}/i

// 通用数字单号
/\d{10,20}/

// 驿站名称
/(.{2,10}?驿站)/
```

### 6. 数据库集成

#### 保存包裹信息
```typescript
await this.database.insertParcel(parcel);
```

#### 更新使用历史
```typescript
await this.database.addOrUpdateCourierCompany(courierCompany);
await this.database.addOrUpdateStationName(stationName);
```

## 测试场景

### 场景一：扫描菜鸟驿站取件码
**输入**：二维码内容包含 "中通快递 6-2-2175 菜鸟驿站 杭州万泰凤华新建店"
**预期输出**：
- 取件码：6-2-2175
- 快递公司：中通快递
- 驿站：菜鸟驿站
- 地址：杭州万泰凤华新建店

### 场景二：扫描顺丰快递单
**输入**：条形码内容 "SF123456789012"
**预期输出**：
- 取件码：SF123456789012
- 快递公司：顺丰速运
- 驿站：驿站（默认）
- 地址：请手动补充地址

### 场景三：扫描未知快递
**输入**：条形码内容 "7890123456789"（无快递公司信息）
**预期输出**：
- 取件码：7890123456789
- 快递公司：未知快递
- 驿站：驿站（默认）
- 地址：请手动补充地址

### 场景四：扫描失败
**输入**：用户取消扫码
**预期输出**：无提示，静默返回

### 场景五：识别失败
**输入**：二维码内容不包含任何单号信息
**预期输出**：提示 "未识别到快递信息，请尝试手动添加"

## 优化点

### 性能优化
- ✅ 异步处理，不阻塞 UI
- ✅ 单次扫描模式，避免重复识别
- ✅ 智能正则匹配，提高识别速度

### 用户体验优化
- ✅ 友好的错误提示
- ✅ 支持从相册选择（适合已拍照场景）
- ✅ 自动刷新列表
- ✅ 详细的成功提示信息

### 容错处理
- ✅ 用户取消静默处理
- ✅ 扫码失败提示重试
- ✅ 识别失败提示手动添加
- ✅ 部分信息缺失使用默认值

## 已知限制

1. **快递公司识别精度**
   - 部分小型快递公司可能识别为"未知快递"
   - 解决方案：支持手动编辑修改

2. **驿站信息提取**
   - 部分快递单二维码不包含驿站信息
   - 解决方案：使用默认值，支持后续编辑

3. **重复扫描**
   - 每次扫描都会创建新记录，不自动去重
   - 考虑：未来可添加重复检测功能

## 后续优化计划

- [ ] 批量扫描模式（连续扫描多个快递单）
- [ ] OCR 文字识别（识别打印的单号）
- [ ] 重复检测（避免重复添加）
- [ ] 历史扫描记录
- [ ] 扫描统计分析
- [ ] 自定义快递公司库
- [ ] 支持更多国际快递公司

## 相关文档

- [扫码功能说明.md](./扫码功能说明.md) - 用户使用指南
- [README.md](../README.md) - 项目总体说明

## 开发者
AI Assistant

## 版本
v1.0 - 首次发布

